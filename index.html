<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>モンハン タイムアタックトラッカー</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
      :root {
        --primary: #8a5319;
        --primary-dark: #6a3d0f;
        --secondary: #c39b60;
        --accent: #e7c78e;
        --background: #f9f3e6;
        --background-dark: #e8e0d0;
        --card-bg: #ffffff;
        --text: #2e1a05;
        --text-light: #5a4530;
        --border-radius: 12px;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s ease;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--background);
        color: var(--text);
        line-height: 1.6;
        padding-bottom: 2rem;
      }

      header {
        background: linear-gradient(
          135deg,
          var(--primary),
          var(--primary-dark)
        );
        color: white;
        padding: 1.5rem;
        text-align: center;
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
        position: relative;
      }

      .logo-container {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 1rem;
      }

      .logo {
        max-height: 100px;
        max-width: 100%;
        object-fit: contain;
      }

      main {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
      }

      .container {
        display: flex;
        flex-wrap: wrap;
        gap: 2rem;
      }

      .control-panel {
        flex: 1;
        min-width: 320px;
      }

      .records-panel {
        flex: 2;
        min-width: 320px;
      }

      .card {
        background-color: var(--card-bg);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        overflow: hidden;
        transition: var(--transition);
        margin-bottom: 2rem;
      }

      .card:hover {
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }

      .card-header {
        background-color: var(--primary);
        padding: 1rem;
        color: white;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .card-body {
        padding: 1.5rem;
      }

      .tab-container {
        position: relative;
        margin-bottom: 1rem;
      }

      .tab-buttons {
        display: flex;
        border-bottom: 2px solid var(--background-dark);
        margin-bottom: 1.5rem;
      }

      .tab-button {
        padding: 0.75rem 1.5rem;
        background: none;
        border: none;
        font-weight: 600;
        color: var(--text-light);
        cursor: pointer;
        transition: var(--transition);
        position: relative;
      }

      .tab-button:hover {
        color: var(--primary);
      }

      .tab-button.active {
        color: var(--primary);
      }

      .tab-button.active::after {
        content: "";
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 100%;
        height: 2px;
        background-color: var(--primary);
      }

      .tab-content {
        display: none;
      }
      .ranking-tabs {
        margin-bottom: 1rem;
      }

      .ranking-content {
        display: none;
      }

      .ranking-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
      }
      .stats-overview {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .stats-card {
        flex: 1;
        min-width: 200px;
        background: var(--card-bg);
        padding: 1.5rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        text-align: center;
        transition: var(--transition);
      }

      .stats-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
      }

      .stats-title {
        font-size: 0.9rem;
        color: var(--text-light);
        margin-bottom: 0.5rem;
      }

      .stats-value {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--primary);
      }

      .stats-charts {
        display: flex;
        flex-wrap: wrap;
        gap: 2rem;
        margin-top: 2rem;
      }

      .stats-chart-container {
        flex: 1;
        min-width: 300px;
        background: var(--card-bg);
        padding: 1.5rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
      }

      .stats-chart-container h3 {
        margin-bottom: 1rem;
        text-align: center;
        color: var(--text);
      }
      .checklist-header {
        margin-bottom: 1.5rem;
      }

      .progress-container {
        background: var(--card-bg);
        padding: 1.5rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
      }

      .progress-text {
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--text);
      }

      .progress-bar {
        height: 10px;
        background-color: var(--background-dark);
        border-radius: 5px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background-color: var(--primary);
        border-radius: 5px;
        transition: width 0.3s ease;
      }

      .checklist-filters {
        margin-bottom: 1.5rem;
      }

      .checklist-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
      }

      .monster-card {
        background: var(--card-bg);
        border-radius: var(--border-radius);
        padding: 1rem;
        box-shadow: var(--shadow);
        transition: var(--transition);
        border-left: 4px solid transparent;
      }

      .monster-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
      }

      .monster-card.completed {
        border-left-color: #4caf50;
      }

      .monster-name {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--text);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .completion-icon {
        color: #4caf50;
      }

      .monster-time {
        font-size: 0.9rem;
        color: var(--text-light);
      }

      .monster-weapon {
        font-size: 0.8rem;
        color: var(--text-light);
        margin-top: 0.25rem;
      }
      .tag-badge {
        display: inline-block;
        background-color: var(--accent);
        color: var(--text);
        font-size: 0.75rem;
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        margin-right: 0.25rem;
        margin-bottom: 0.25rem;
      }

      .tags-cell {
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .tags-cell:hover {
        white-space: normal;
        overflow: visible;
      }
      .trends-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .trends-filters .form-group {
        flex: 1;
        min-width: 200px;
      }

      .trend-chart-container {
        background: var(--card-bg);
        padding: 1.5rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
        display: none;
      }

      .trend-empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-light);
      }

      .trend-empty-state .empty-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }
      .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text);
      }

      .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
        transition: var(--transition);
      }

      .form-control:focus {
        outline: none;
        border-color: var(--secondary);
        box-shadow: 0 0 0 3px rgba(195, 155, 96, 0.2);
      }

      .btn {
        display: inline-block;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        text-align: center;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: var(--transition);
        font-size: 1rem;
      }

      .btn-primary {
        background-color: var(--primary);
        color: white;
      }

      .btn-primary:hover {
        background-color: var(--primary-dark);
      }

      .btn-secondary {
        background-color: var(--secondary);
        color: white;
      }

      .btn-secondary:hover {
        background-color: #b38c50;
      }

      .btn-danger {
        background-color: #d9534f;
        color: white;
      }

      .btn-danger:hover {
        background-color: #c9302c;
      }

      .btn-block {
        display: block;
        width: 100%;
      }

      .time-input {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .time-input .form-control {
        width: 70px;
        text-align: center;
      }

      .time-input span {
        font-weight: 600;
        color: var(--text);
      }

      .search-box {
        margin-bottom: 1.5rem;
        position: relative;
      }

      .search-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }

      .search-filters .form-control {
        width: auto;
        flex-grow: 1;
        min-width: 150px;
      }

      .search-icon {
        position: absolute;
        top: 50%;
        left: 15px;
        transform: translateY(-50%);
        color: var(--text-light);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }

      table th,
      table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid #eee;
      }

      table th {
        background-color: var(--background-dark);
        font-weight: 600;
        color: var(--text);
      }

      table tr:hover {
        background-color: rgba(231, 199, 142, 0.2);
      }

      .actions-cell {
        display: flex;
        gap: 0.5rem;
      }

      .action-btn {
        width: 30px;
        height: 30px;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 4px;
        cursor: pointer;
        transition: var(--transition);
        background-color: var(--background);
        color: var(--text);
      }

      .action-btn:hover {
        background-color: var(--primary);
        color: white;
      }

      .action-btn.delete {
        background-color: rgba(217, 83, 79, 0.1);
        color: #d9534f;
      }

      .action-btn.delete:hover {
        background-color: #d9534f;
        color: white;
      }

      .image-preview {
        width: 50px;
        height: 50px;
        border-radius: 4px;
        object-fit: cover;
        cursor: pointer;
        transition: var(--transition);
      }

      .image-preview:hover {
        transform: scale(1.1);
      }

      #imageModal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        transition: var(--transition);
      }

      .modal-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding: 2rem;
      }

      .modal-image {
        max-width: 90%;
        max-height: 80vh;
        border-radius: 6px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      }

      .modal-close {
        position: absolute;
        top: 20px;
        right: 20px;
        color: white;
        font-size: 2rem;
        cursor: pointer;
        transition: var(--transition);
      }

      .modal-close:hover {
        color: var(--accent);
      }

      .image-upload {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1.5rem;
        border: 2px dashed #ddd;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        background-color: #f9f9f9;
        transition: var(--transition);
        cursor: pointer;
      }

      .image-upload:hover {
        border-color: var(--secondary);
        background-color: rgba(231, 199, 142, 0.1);
      }

      .image-upload-icon {
        font-size: 2rem;
        color: var(--text-light);
        margin-bottom: 0.75rem;
      }

      .image-upload input {
        display: none;
      }

      .image-preview-container {
        margin-top: 1rem;
        display: flex;
        justify-content: center;
      }

      .form-preview-image {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        box-shadow: var(--shadow);
      }

      .image-remove {
        margin-top: 0.5rem;
        color: #d9534f;
        cursor: pointer;
        font-size: 0.9rem;
      }

      .image-remove:hover {
        text-decoration: underline;
      }

      .hr {
        margin: 2rem 0;
        border: none;
        height: 1px;
        background-color: #ddd;
      }

      .text-center {
        text-align: center;
      }

      .text-muted {
        color: var(--text-light);
        font-size: 0.9rem;
      }

      .empty-state {
        padding: 3rem;
        text-align: center;
        color: var(--text-light);
      }

      .empty-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }

      .filters-toggle {
        margin-bottom: 1rem;
        cursor: pointer;
        color: var(--primary);
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      @media (max-width: 768px) {
        .container {
          flex-direction: column;
        }

        .control-panel,
        .records-panel {
          width: 100%;
        }

        .tab-button {
          padding: 0.5rem 1rem;
          font-size: 0.9rem;
        }

        .card-body {
          padding: 1rem;
        }

        .time-input .form-control {
          width: 60px;
        }

        table th,
        table td {
          padding: 0.5rem;
          font-size: 0.9rem;
        }

        .table-responsive {
          overflow-x: auto;
        }

        .logo {
          max-height: 70px;
        }
      }
      /* ダークモードのスタイル */
      body.dark-mode {
        --primary: #6a3d0f;
        --primary-dark: #4a2d0f;
        --secondary: #8a5319;
        --accent: #b3834b;
        --background: #292520;
        --background-dark: #1e1c19;
        --card-bg: #332e29;
        --text: #e0d0c0;
        --text-light: #c0b0a0;
      }

      .theme-toggle {
        position: absolute;
        top: 60px;
        right: 20px;
        font-size: 1.5rem;
        color: white;
        background: none;
        border: none;
        cursor: pointer;
        transition: var(--transition);
      }

      .theme-toggle:hover {
        color: var(--accent);
        transform: scale(1.1);
      }

      /* 以下を追加: モバイル最適化 */
      .tab-buttons {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        white-space: nowrap;
        padding-bottom: 5px;
      }

      .tab-button {
        display: inline-block;
        white-space: nowrap;
        flex-shrink: 0;
      }

      /* 共有機能のスタイル */
      .share-modal {
        display: flex;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .share-modal.active {
        opacity: 1;
      }

      .share-modal-content {
        background-color: var(--card-bg);
        padding: 2rem;
        border-radius: var(--border-radius);
        max-width: 90%;
        width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .share-modal-close {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-light);
      }

      .share-details {
        margin: 1.5rem 0;
      }

      .share-options {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
      }

      .share-btn {
        flex: 1;
        min-width: 120px;
      }

      .qr-code-container {
        display: flex;
        justify-content: center;
        margin: 1rem 0;
      }

      .share-status {
        text-align: center;
        color: var(--primary);
        font-weight: 600;
        min-height: 1.5rem;
      }

      /* バックアップ設定スタイル */
      .backup-settings {
        margin-bottom: 1.5rem;
      }

      .backup-status {
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: var(--text-light);
      }

      /* 詳細ランキングスタイル */
      .ranking-filter {
        margin-bottom: 1rem;
      }

      .action-btn.share {
        background-color: rgba(74, 144, 226, 0.1);
        color: #4a90e2;
      }

      .action-btn.share:hover {
        background-color: #4a90e2;
        color: white;
      }

      /* スマホ最適化のためのタッチ操作改善 */
      @media (max-width: 768px) {
        .action-btn {
          width: 40px;
          height: 40px;
        }

        .form-control,
        .btn {
          padding: 0.8rem;
        }

        .share-options {
          flex-direction: column;
        }

        .tab-button {
          padding: 0.8rem 1.2rem;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="logo-container">
        <img
          id="headerLogo"
          class="logo"
          src="./images/logo.png"
          alt="モンハン タイムアタックトラッカー"
        />
      </div>
      <h1>モンハン タイムアタックトラッカー</h1>
      <button id="themeToggle" class="theme-toggle">
        <i class="fas fa-moon"></i>
      </button>
      <!-- ここに追加 -->
      <div id="header-profile" class="header-profile" style="display: none">
        <div class="header-profile-avatar"></div>
        <span class="header-profile-name">ハンター名</span>
      </div>
    </header>

    <main>
      <div class="container">
        <div class="control-panel">
          <div class="card">
            <div class="card-header">コントロールパネル</div>
            <div class="card-body">
              <div class="tab-container">
                <div class="tab-buttons">
                  <button
                    class="tab-button active"
                    onclick="openTab('add-record')"
                  >
                    記録追加
                  </button>
                  <button class="tab-button" onclick="openTab('import-export')">
                    インポート/エクスポート
                  </button>
                  <button class="tab-button" onclick="openTab('rankings')">
                    ランキング
                  </button>
                  <button class="tab-button" onclick="openTab('statistics')">
                    統計
                  </button>
                  <button class="tab-button" onclick="openTab('checklist')">
                    チェックリスト
                  </button>
                  <button class="tab-button" onclick="openTab('trends')">
                    トレンド
                  </button>
                  <button
                    class="tab-button"
                    onclick="openTab('backup-settings')"
                  >
                    バックアップ
                  </button>
                  <button class="tab-button" onclick="openTab('simulation')">シミュレーション</button>
                </div>

                <!-- 記録追加タブ -->
                <div id="add-record" class="tab-content active">
                  <form id="record-form">
                    <div class="form-group">
                      <label for="monster-select" class="form-label"
                        >モンスター選択:</label
                      >
                      <select id="monster-select" class="form-control" required>
                        <option value="">モンスターを選択</option>
                        <!-- モンスターリストはJavaScriptで動的に生成 -->
                      </select>
                    </div>

                    <div class="form-group">
                      <label for="weapon-select" class="form-label"
                        >武器種:</label
                      >
                      <select id="weapon-select" class="form-control" required>
                        <option value="">武器を選択</option>
                        <option value="大剣">大剣</option>
                        <option value="太刀">太刀</option>
                        <option value="片手剣">片手剣</option>
                        <option value="双剣">双剣</option>
                        <option value="ハンマー">ハンマー</option>
                        <option value="狩猟笛">狩猟笛</option>
                        <option value="ランス">ランス</option>
                        <option value="ガンランス">ガンランス</option>
                        <option value="スラッシュアックス">
                          スラッシュアックス
                        </option>
                        <option value="チャージアックス">
                          チャージアックス
                        </option>
                        <option value="操虫棍">操虫棍</option>
                        <option value="ライトボウガン">ライトボウガン</option>
                        <option value="ヘビィボウガン">ヘビィボウガン</option>
                        <option value="弓">弓</option>
                      </select>
                    </div>

                    <div class="form-group">
                      <label for="quest-type" class="form-label"
                        >クエストタイプ:</label
                      >
                      <select id="quest-type" class="form-control" required>
                        <option value="通常">通常</option>
                        <option value="歴戦">歴戦</option>
                        <option value="狂竜化">狂竜化</option>
                      </select>
                    </div>

                    <div class="form-group">
                      <label for="stage-select" class="form-label"
                        >ステージ:</label
                      >
                      <select id="stage-select" class="form-control" required>
                        <option value="">ステージを選択</option>
                        <option value="隔ての砂原">隔ての砂原</option>
                        <option value="緋の森">緋の森</option>
                        <option value="油涌き谷">油涌き谷</option>
                        <option value="氷霧の断崖">氷霧の断崖</option>
                        <option value="竜都の跡形">竜都の跡形</option>
                        <option value="竜谷の跡地(闘技場)">
                          竜谷の跡地(闘技場)
                        </option>
                        <option value="その他">その他</option>
                      </select>
                    </div>

                    <div class="form-group">
                      <label for="strength" class="form-label">強さ:</label>
                      <select id="strength" class="form-control" required>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                      </select>
                    </div>

                    <div class="form-group">
                      <label class="form-label">タイム:</label>
                      <div class="time-input">
                        <input
                          type="number"
                          id="time-minutes"
                          class="form-control"
                          min="0"
                          placeholder="分"
                          required
                        />
                        <span>:</span>
                        <input
                          type="number"
                          id="time-seconds"
                          class="form-control"
                          min="0"
                          max="59"
                          placeholder="秒"
                          required
                        />
                        <span>.</span>
                        <input
                          type="number"
                          id="time-milliseconds"
                          class="form-control"
                          min="0"
                          max="99"
                          placeholder="ミリ秒"
                          required
                        />
                      </div>
                    </div>

                    <div class="form-group">
                      <label for="notes" class="form-label">メモ:</label>
                      <input
                        type="text"
                        id="notes"
                        class="form-control"
                        placeholder="装備や戦略など"
                      />
                    </div>

                    <div class="form-group">
                      <label for="tags" class="form-label">タグ:</label>
                      <input
                        type="text"
                        id="tags"
                        class="form-control"
                        placeholder="カンマ区切りでタグを入力（例: 事故、練習中、装備検証）"
                      />
                    </div>

                    <div class="form-group">
                      <label class="form-label">スクリーンショット:</label>
                      <div class="image-upload" id="imageUploadContainer">
                        <i
                          class="fas fa-cloud-upload-alt image-upload-icon"
                        ></i>
                        <span>クリックして画像をアップロード</span>
                        <input type="file" id="imageUpload" accept="image/*" />
                      </div>
                      <div
                        class="image-preview-container"
                        id="imagePreviewContainer"
                        style="display: none"
                      >
                        <div>
                          <img
                            id="formPreviewImage"
                            class="form-preview-image"
                            src=""
                            alt="プレビュー"
                          />
                          <div class="text-center">
                            <span class="image-remove" id="removeImage"
                              >画像を削除</span
                            >
                          </div>
                        </div>
                      </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block">
                      記録を保存
                    </button>
                  </form>
                </div>

                <!-- インポート/エクスポートタブ -->
                <div id="import-export" class="tab-content">
                  <div class="form-group">
                    <button
                      id="export-json"
                      class="btn btn-secondary btn-block"
                    >
                      JSONでエクスポート
                    </button>
                  </div>

                  <div class="form-group">
                    <label for="import-file" class="form-label"
                      >JSONファイルをインポート:</label
                    >
                    <input
                      type="file"
                      id="import-file"
                      class="form-control"
                      accept=".json"
                    />
                  </div>

                  <div class="form-group">
                    <button
                      id="import-button"
                      class="btn btn-secondary btn-block"
                    >
                      インポート
                    </button>
                  </div>

                  <div class="hr"></div>

                  <div class="form-group">
                    <button id="clear-data" class="btn btn-danger btn-block">
                      全データ削除
                    </button>
                  </div>
                </div>

                <!-- ランキングタブ -->
                <div id="rankings" class="tab-content">
                  <div class="tab-container">
                    <div class="tab-buttons ranking-tabs">
                      <button
                        class="tab-button active"
                        onclick="openRankingTab('monster-ranking')"
                      >
                        モンスター別
                      </button>
                      <button
                        class="tab-button"
                        onclick="openRankingTab('weapon-ranking')"
                      >
                        武器種別
                      </button>
                      <button
                        class="tab-button"
                        onclick="openRankingTab('combined-ranking')"
                      >
                        モンスター×武器
                      </button>
                      <button
                        class="tab-button"
                        onclick="openRankingTab('stage-ranking')"
                      >
                        ステージ別
                      </button>
                      <button
                        class="tab-button"
                        onclick="openRankingTab('quest-ranking')"
                      >
                        クエスト別
                      </button>
                    </div>

                    <div id="monster-ranking" class="ranking-content active">
                      <div class="table-responsive">
                        <table id="monster-ranking-table">
                          <thead>
                            <tr>
                              <th>モンスター</th>
                              <th>ベストタイム</th>
                              <th>武器種</th>
                              <th>日付</th>
                              <th>共有</th>
                            </tr>
                          </thead>
                          <tbody>
                            <!-- ランキングデータはJSで動的に生成 -->
                          </tbody>
                        </table>
                      </div>
                    </div>

                    <div id="weapon-ranking" class="ranking-content">
                      <div class="table-responsive">
                        <table id="weapon-ranking-table">
                          <thead>
                            <tr>
                              <th>武器種</th>
                              <th>モンスター</th>
                              <th>ベストタイム</th>
                              <th>日付</th>
                              <th>共有</th>
                            </tr>
                          </thead>
                          <tbody>
                            <!-- ランキングデータはJSで動的に生成 -->
                          </tbody>
                        </table>
                      </div>
                    </div>
                    <!-- 以下を追加: 新しいランキング -->
                    <div id="combined-ranking" class="ranking-content">
                      <div class="ranking-filter">
                        <select
                          id="combined-monster-filter"
                          class="form-control"
                        >
                          <option value="">モンスターでフィルター</option>
                          <!-- 動的に生成 -->
                        </select>
                      </div>
                      <div class="table-responsive">
                        <table id="combined-ranking-table">
                          <thead>
                            <tr>
                              <th>モンスター</th>
                              <th>武器種</th>
                              <th>ベストタイム</th>
                              <th>日付</th>
                              <th>共有</th>
                            </tr>
                          </thead>
                          <tbody>
                            <!-- ランキングデータはJSで動的に生成 -->
                          </tbody>
                        </table>
                      </div>
                    </div>

                    <div id="stage-ranking" class="ranking-content">
                      <div class="table-responsive">
                        <table id="stage-ranking-table">
                          <thead>
                            <tr>
                              <th>ステージ</th>
                              <th>モンスター</th>
                              <th>武器種</th>
                              <th>ベストタイム</th>
                              <th>日付</th>
                              <th>共有</th>
                            </tr>
                          </thead>
                          <tbody>
                            <!-- ランキングデータはJSで動的に生成 -->
                          </tbody>
                        </table>
                      </div>
                    </div>

                    <div id="quest-ranking" class="ranking-content">
                      <div class="table-responsive">
                        <table id="quest-ranking-table">
                          <thead>
                            <tr>
                              <th>クエストタイプ</th>
                              <th>モンスター</th>
                              <th>武器種</th>
                              <th>ベストタイム</th>
                              <th>日付</th>
                              <th>共有</th>
                            </tr>
                          </thead>
                          <tbody>
                            <!-- ランキングデータはJSで動的に生成 -->
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 統計タブ -->
                <div id="statistics" class="tab-content">
                  <div class="stats-overview">
                    <div class="stats-card">
                      <div class="stats-title">総ハント数</div>
                      <div id="total-hunts" class="stats-value">0</div>
                    </div>
                    <div class="stats-card">
                      <div class="stats-title">平均クリアタイム</div>
                      <div id="avg-time" class="stats-value">00:00.00</div>
                    </div>
                    <div class="stats-card">
                      <div class="stats-title">最も狩猟したモンスター</div>
                      <div id="most-hunted" class="stats-value">-</div>
                    </div>
                    <div class="stats-card">
                      <div class="stats-title">最も使用した武器</div>
                      <div id="most-used-weapon" class="stats-value">-</div>
                    </div>
                  </div>

                  <div class="stats-charts">
                    <div class="stats-chart-container">
                      <h3>モンスター別狩猟回数</h3>
                      <canvas id="monsters-chart"></canvas>
                    </div>
                    <div class="stats-chart-container">
                      <h3>武器種別使用回数</h3>
                      <canvas id="weapons-chart"></canvas>
                    </div>
                  </div>
                </div>

                <!-- チェックリストタブ -->
                <div id="checklist" class="tab-content">
                  <div class="checklist-header">
                    <div class="progress-container">
                      <div class="progress-text">
                        攻略率: <span id="completion-rate">0%</span>
                      </div>
                      <div class="progress-bar">
                        <div
                          id="progress-fill"
                          class="progress-fill"
                          style="width: 0%"
                        ></div>
                      </div>
                    </div>
                  </div>

                  <div class="checklist-filters">
                    <select id="checklist-filter" class="form-control">
                      <option value="all">すべてのモンスター</option>
                      <option value="completed">攻略済み</option>
                      <option value="incomplete">未攻略</option>
                    </select>
                  </div>

                  <div id="checklist-container" class="checklist-container">
                    <!-- チェックリストはJSで動的に生成 -->
                  </div>
                </div>
                <div id="trends" class="tab-content">
                  <div class="trends-filters">
                    <div class="form-group">
                      <label for="trend-monster" class="form-label"
                        >モンスター:</label
                      >
                      <select id="trend-monster" class="form-control">
                        <option value="">モンスターを選択</option>
                        <!-- 動的に生成 -->
                      </select>
                    </div>

                    <div class="form-group">
                      <label for="trend-weapon" class="form-label"
                        >武器種（オプション）:</label
                      >
                      <select id="trend-weapon" class="form-control">
                        <option value="">すべての武器種</option>
                        <option value="大剣">大剣</option>
                        <option value="太刀">太刀</option>
                        <option value="片手剣">片手剣</option>
                        <option value="双剣">双剣</option>
                        <option value="ハンマー">ハンマー</option>
                        <option value="狩猟笛">狩猟笛</option>
                        <option value="ランス">ランス</option>
                        <option value="ガンランス">ガンランス</option>
                        <option value="スラッシュアックス">
                          スラッシュアックス
                        </option>
                        <option value="チャージアックス">
                          チャージアックス
                        </option>
                        <option value="操虫棍">操虫棍</option>
                        <option value="ライトボウガン">ライトボウガン</option>
                        <option value="ヘビィボウガン">ヘビィボウガン</option>
                        <option value="弓">弓</option>
                      </select>
                    </div>
                  </div>

                  <div class="trend-chart-container">
                    <canvas id="trend-chart"></canvas>
                  </div>

                  <div class="trend-empty-state" id="trend-empty-state">
                    <i class="fas fa-chart-line empty-icon"></i>
                    <p>モンスターを選択すると、タイムの推移を表示します</p>
                  </div>
                </div>
                <!-- バックアップ設定タブ -->
                <div id="backup-settings" class="tab-content">
                  <div class="backup-settings">
                    <h3>自動バックアップ設定</h3>

                    <div class="form-group">
                      <label class="checkbox-label">
                        <input type="checkbox" id="backup-enabled" />
                        自動バックアップを有効にする
                      </label>
                    </div>

                    <div class="form-group">
                      <label for="backup-interval" class="form-label"
                        >バックアップ頻度:</label
                      >
                      <select id="backup-interval" class="form-control">
                        <option value="daily">毎日</option>
                        <option value="weekly">毎週</option>
                        <option value="monthly">毎月</option>
                      </select>
                    </div>

                    <div class="backup-status">
                      最終バックアップ: <span id="last-backup-date">なし</span>
                    </div>

                    <div class="form-group">
                      <button
                        id="save-backup-settings"
                        class="btn btn-primary btn-block"
                      >
                        設定を保存
                      </button>
                    </div>

                    <div class="form-group">
                      <button
                        id="manual-backup"
                        class="btn btn-secondary btn-block"
                      >
                        今すぐバックアップを実行
                      </button>
                    </div>
                  </div>
                </div>
                <div id="simulation" class="tab-content">
                  <h2>装備シミュレーション</h2>
                  <div class="form-group">
                    <label for="sim-weapon" class="form-label">武器:</label>
                    <select id="sim-weapon" class="form-control"></select>
                    <div id="deco-slots-weapon" class="deco-container"></div>
                  </div>
                  <div class="form-group">
                    <label for="sim-head" class="form-label">頭装備:</label>
                    <select id="sim-head" class="form-control"></select>
                    <div id="deco-slots-head" class="deco-container"></div>
                  </div>
                  <div class="form-group">
                    <label for="sim-body" class="form-label">胴装備:</label>
                    <select id="sim-body" class="form-control"></select>
                    <div id="deco-slots-body" class="deco-container"></div>
                  </div>
                  <div class="form-group">
                    <label for="sim-arms" class="form-label">腕装備:</label>
                    <select id="sim-arms" class="form-control"></select>
                    <div id="deco-slots-arms" class="deco-container"></div>
                  </div>
                  <div class="form-group">
                    <label for="sim-waist" class="form-label">腰装備:</label>
                    <select id="sim-waist" class="form-control"></select>
                    <div id="deco-slots-waist" class="deco-container"></div>
                  </div>
                  <div class="form-group">
                    <label for="sim-legs" class="form-label">脚装備:</label>
                    <select id="sim-legs" class="form-control"></select>
                    <div id="deco-slots-legs" class="deco-container"></div>
                  </div>
                  <div class="form-group">
                    <label for="sim-charm" class="form-label">護石:</label>
                    <select id="sim-charm" class="form-control"></select>
                  </div>
                  <button id="run-simulation" class="btn btn-primary btn-block">シミュレーション実行</button>

                  <div id="simulation-results" style="margin-top:1.5rem;">
                    <h3>発動スキル</h3>
                    <ul id="sim-skill-list"></ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="records-panel">
          <div class="card">
            <div class="card-header">記録一覧</div>
            <div class="card-body">
              <div class="filters-toggle" onclick="toggleFilterPanel()">
                <i class="fas fa-filter"></i> フィルター
              </div>

              <div id="filter-panel" class="search-box">
                <div class="search-filters">
                  <select id="filter-monster" class="form-control">
                    <option value="">モンスター（全て）</option>
                    <!-- 動的に生成 -->
                  </select>

                  <select id="filter-weapon" class="form-control">
                    <option value="">武器種（全て）</option>
                    <option value="大剣">大剣</option>
                    <option value="太刀">太刀</option>
                    <option value="片手剣">片手剣</option>
                    <option value="双剣">双剣</option>
                    <option value="ハンマー">ハンマー</option>
                    <option value="狩猟笛">狩猟笛</option>
                    <option value="ランス">ランス</option>
                    <option value="ガンランス">ガンランス</option>
                    <option value="スラッシュアックス">
                      スラッシュアックス
                    </option>
                    <option value="チャージアックス">チャージアックス</option>
                    <option value="操虫棍">操虫棍</option>
                    <option value="ライトボウガン">ライトボウガン</option>
                    <option value="ヘビィボウガン">ヘビィボウガン</option>
                    <option value="弓">弓</option>
                  </select>

                  <select id="filter-quest" class="form-control">
                    <option value="">クエストタイプ（全て）</option>
                    <option value="通常">通常</option>
                    <option value="歴戦">歴戦</option>
                    <option value="狂竜化">狂竜化</option>
                  </select>

                  <select id="filter-stage" class="form-control">
                    <option value="">ステージ（全て）</option>
                    <!-- 動的に生成 -->
                  </select>
                  <select id="filter-tag" class="form-control">
                    <option value="">タグ（全て）</option>
                    <!-- 動的に生成 -->
                  </select>
                </div>

                <div class="search-text">
                  <i class="fas fa-search search-icon"></i>
                  <input
                    type="text"
                    id="search-input"
                    class="form-control"
                    placeholder="テキスト検索..."
                  />
                </div>
              </div>

              <div class="table-responsive">
                <table id="records-table">
                  <thead>
                    <tr>
                      <th>モンスター</th>
                      <th>武器種</th>
                      <th>クエスト</th>
                      <th>ステージ</th>
                      <th>強さ</th>
                      <th>タイム</th>
                      <th>登録日</th>
                      <th>タグ</th>
                      <th>画像</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- テーブルの内容はJavaScriptで動的に生成 -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- 画像モーダル -->
    <div id="imageModal">
      <span class="modal-close">&times;</span>
      <div class="modal-content">
        <img
          id="modalImage"
          class="modal-image"
          src=""
          alt="スクリーンショット"
        />
      </div>
    </div>

    <div id="share-modal-template" style="display: none">
      <div class="share-modal">
        <div class="share-modal-content">
          <span class="share-modal-close">&times;</span>
          <h3>共有</h3>
          <div class="share-details"></div>
          <div class="share-options"></div>
          <div id="qrCodeContainer" class="qr-code-container"></div>
          <div id="shareStatus" class="share-status"></div>
        </div>
      </div>
    </div>

    <script>
        // モンスターリスト
        const monsters = [
            "チャタカブラ", "ケマトリス", "ラバラバリナ", "ババコンガ", "バーラハーラ",
            "ドシャグマ", "ウズトゥナ", "ププロポル", "レダウ", "ネルスキュラ",
            "ヒラバミ", "アジャラカン", "ヌエグドラ", "護竜ドシャグマ", "護竜リオレウス",
            "護竜アルシュベルド", "ジンダハド", "護竜オドガロン亜種", "シーウー", "ゾシア",
            "護竜アンジャナフ亜種", "ドドブランゴ", "タマミツネ", "グラビモス", "リオレイア",
            "リオレウス", "ゴアマガラ", "アルシュベルド", "ゲリョス", "イャンクック",
            "歴戦チャタカブラ", "歴戦ケマトリス", "歴戦ラバラバリナ", "歴戦ババコンガ", "歴戦バーラハーラ",
            "歴戦ドシャグマ", "歴戦ウズトゥナ", "歴戦ププロポル", "歴戦レダウ", "歴戦ネルスキュラ",
            "歴戦ヒラバミ", "歴戦アジャラカン", "歴戦ヌエグドラ", "歴戦護竜ドシャグマ", "歴戦護竜リオレウス",
            "歴戦ジンダハド", "歴戦護竜オドガロン亜種", "歴戦シーウー", "歴戦護竜アンジャナフ亜種", "歴戦ドドブランゴ",
            "歴戦タマミツネ", "歴戦グラビモス", "歴戦リオレイア", "歴戦リオレウス", "歴戦ゴアマガラ",
            "歴戦アルシュベルド", "歴戦ゲリョス", "歴戦イャンクック", "狂竜化ドドブランゴ", "狂竜化ヒラバミ",
            "狂竜化ネルスキュラ", "狂竜化ゲリョス", "狂竜化イャンクック", "歴戦王レダウ", "ラギアクルス"
        ];

        // ステージリスト
        const stages = [
            "隔ての砂原", "緋の森", "油涌き谷", "氷霧の断崖", "竜都の跡形", "竜谷の跡地(闘技場)", "その他"
        ];

        // ローカルストレージとIndexedDBのキー
        const STORAGE_KEY = 'mh-timeattack-records';
        const DB_NAME = 'MonsterHunterTimeAttack';
        const DB_VERSION = 1;
        const IMAGES_STORE = 'images';

        // 記録データを初期化
        let recordsData = [];
        let imageFile = null;

        // フィルター用ユニーク値の保存
        let uniqueMonsters = new Set();
        let uniqueStages = new Set();
        let uniqueTags = new Set();

        // IndexedDB初期化
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = function(event) {
                    const db = event.target.result;
                    // 画像を保存するオブジェクトストア
                    if (!db.objectStoreNames.contains(IMAGES_STORE)) {
                        db.createObjectStore(IMAGES_STORE, { keyPath: 'id' });
                    }
                };
                request.onsuccess = function(event) {
                    resolve(event.target.result);
                };

                request.onerror = function(event) {
                    console.error('データベースの初期化に失敗しました:', event.target.error);
                    reject('データベースの初期化に失敗しました');
                };
            });
        }

        // 画像を保存
        function saveImage(id, imageData) {
            return new Promise((resolve, reject) => {
                initDB().then(db => {
                    const transaction = db.transaction([IMAGES_STORE], 'readwrite');
                    const store = transaction.objectStore(IMAGES_STORE);

                    store.put({
                        id: id,
                        data: imageData
                    });

                    transaction.oncomplete = function() {
                        resolve(id);
                    };

                    transaction.onerror = function(event) {
                        console.error('画像の保存に失敗しました:', event.target.error);
                        reject('画像の保存に失敗しました');
                    };
                }).catch(reject);
            });
        }

        // 画像を取得
        function getImage(id) {
            return new Promise((resolve, reject) => {
                initDB().then(db => {
                    const transaction = db.transaction([IMAGES_STORE], 'readonly');
                    const store = transaction.objectStore(IMAGES_STORE);
                    const request = store.get(id);

                    request.onsuccess = function(event) {
                        resolve(event.target.result ? event.target.result.data : null);
                    };

                    request.onerror = function(event) {
                        console.error('画像の取得に失敗しました:', event.target.error);
                        reject('画像の取得に失敗しました');
                    };
                }).catch(reject);
            });
        }

        // 画像を削除
        function deleteImage(id) {
            return new Promise((resolve, reject) => {
                initDB().then(db => {
                    const transaction = db.transaction([IMAGES_STORE], 'readwrite');
                    const store = transaction.objectStore(IMAGES_STORE);

                    const request = store.delete(id);

                    request.onsuccess = function() {
                        resolve();
                    };

                    request.onerror = function(event) {
                        console.error('画像の削除に失敗しました:', event.target.error);
                        reject('画像の削除に失敗しました');
                    };
                }).catch(reject);
            });
        }

        // 全ての画像を削除
        function deleteAllImages() {
            return new Promise((resolve, reject) => {
                initDB().then(db => {
                    const transaction = db.transaction([IMAGES_STORE], 'readwrite');
                    const store = transaction.objectStore(IMAGES_STORE);
                    const request = store.clear();

                    request.onsuccess = function() {
                        resolve();
                    };

                    request.onerror = function(event) {
                        console.error('すべての画像の削除に失敗しました:', event.target.error);
                        reject('すべての画像の削除に失敗しました');
                    };
                }).catch(reject);
            });
        }

        // すべての画像をエクスポート
        async function exportAllImages() {
            const imageData = {};

            try {
                const db = await initDB();
                const transaction = db.transaction([IMAGES_STORE], 'readonly');
                const store = transaction.objectStore(IMAGES_STORE);
                const request = store.getAll();

                return new Promise((resolve, reject) => {
                    request.onsuccess = function(event) {
                        const images = event.target.result;

                        images.forEach(image => {
                            imageData[image.id] = image.data;
                        });

                        resolve(imageData);
                    };

                    request.onerror = function(event) {
                        console.error('画像のエクスポートに失敗しました:', event.target.error);
                        reject('画像のエクスポートに失敗しました');
                    };
                });
            } catch (error) {
                console.error('画像のエクスポート中にエラーが発生しました:', error);
                return {};
            }
        }

        // すべての画像をインポート
        async function importAllImages(imageData) {
            try {
                const db = await initDB();
                const transaction = db.transaction([IMAGES_STORE], 'readwrite');
                const store = transaction.objectStore(IMAGES_STORE);

                // 一度に全ての処理を待つために配列に入れる
                const promises = [];

                for (const [id, data] of Object.entries(imageData)) {
                    promises.push(
                        new Promise((resolve, reject) => {
                            const request = store.put({
                                id: id,
                                data: data
                            });

                            request.onsuccess = resolve;
                            request.onerror = reject;
                        })
                    );
                }

                await Promise.all(promises);
                return true;
            } catch (error) {
                console.error('画像のインポート中にエラーが発生しました:', error);
                return false;
            }
        }

        // DOMが読み込まれたら実行
        document.addEventListener('DOMContentLoaded', function() {
            // モンスターリストを生成
            populateMonsterSelect();

            // 保存されたデータを読み込む
            loadRecords();

            // ランキングを初期化
            updateRankings();

            // 統計を初期化
            updateStatistics();

            // チェックリストを初期化
            updateChecklist();

            // トレンドを初期化
            initTrends();

            // フォーム送信イベントを設定
            document.getElementById('record-form').addEventListener('submit', saveRecord);

            // 検索イベントを設定
            document.getElementById('search-input').addEventListener('input', filterRecords);

            // フィルターイベントを設定
            document.getElementById('filter-monster').addEventListener('change', filterRecords);
            document.getElementById('filter-weapon').addEventListener('change', filterRecords);
            document.getElementById('filter-quest').addEventListener('change', filterRecords);
            document.getElementById('filter-stage').addEventListener('change', filterRecords);
            document.getElementById('filter-tag').addEventListener('change', filterRecords);

            // エクスポートボタンイベントを設定
            document.getElementById('export-json').addEventListener('click', exportToJson);

            // インポートボタンイベントを設定
            document.getElementById('import-button').addEventListener('click', importFromJson);

            // クリアボタンイベントを設定
            document.getElementById('clear-data').addEventListener('click', clearAllData);

            // 画像アップロードイベントを設定
            setupImageUpload();

            // 画像モーダルイベントを設定
            setupImageModal();

            // ダークモード設定を読み込む
            loadThemePreference();

            // テーマ切り替えボタンのイベントリスナー
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // チェックリストフィルターのイベントリスナー
            document.getElementById('checklist-filter').addEventListener('change', updateChecklist);

            // バックアップ設定を読み込む
            loadBackupSettings();

            // バックアップ設定保存ボタンのイベントリスナー
            document.getElementById('save-backup-settings').addEventListener('click', function() {
                backupSettings.enabled = document.getElementById('backup-enabled').checked;
                backupSettings.interval = document.getElementById('backup-interval').value;
                saveBackupSettings();
                alert('バックアップ設定を保存しました');
            });

            // 手動バックアップボタンのイベントリスナー
            document.getElementById('manual-backup').addEventListener('click', function() {
                performBackup().then(() => {
                    alert('バックアップが完了しました');
                }).catch(error => {
                    console.error('バックアップに失敗しました:', error);
                    alert('バックアップに失敗しました');
                });
            });

            // 共有リンクの処理
            processShareLink();
        });

        // ページが完全に読み込まれた後に実行
        window.addEventListener('load', function() {
            // バックアップタイマーを設定
            setupBackupTimer();

            // 通知許可を確認（バックアップ通知用）
            if ('Notification' in window) {
                if (Notification.permission === 'default') {
                    Notification.requestPermission();
                } else if (Notification.permission === 'denied') {
                    console.log('通知が許可されていないため、バックアップ通知は表示されません');
                    // 任意: UIにメッセージを表示
                }
            }
        });

        // 統計データの生成と表示
        function updateStatistics() {
            if (recordsData.length === 0) {
                document.getElementById('total-hunts').textContent = '0';
                document.getElementById('avg-time').textContent = '00:00.00';
                document.getElementById('most-hunted').textContent = '-';
                document.getElementById('most-used-weapon').textContent = '-';

                // 空のチャートを表示
                createEmptyCharts();
                return;
            }

            // 統計データの計算
            // モンスター別カウント
            const monsterCounts = {};
            recordsData.forEach(record => {
                monsterCounts[record.monster] = (monsterCounts[record.monster] || 0) + 1;
            });

            // 武器種別カウント
            const weaponCounts = {};
            recordsData.forEach(record => {
                weaponCounts[record.weapon] = (weaponCounts[record.weapon] || 0) + 1;
            });

            // 平均クリアタイム計算
            let totalTime = 0;
            recordsData.forEach(record => {
                totalTime += record.timeValue;
            });
            const avgTime = totalTime / recordsData.length;

            // 平均時間をフォーマット
            const avgMinutes = Math.floor(avgTime / (60 * 1000));
            const avgSeconds = Math.floor((avgTime % (60 * 1000)) / 1000);
            const avgMilliseconds = Math.floor((avgTime % 1000) / 10);
            const avgTimeString = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}.${avgMilliseconds.toString().padStart(2, '0')}`;

            // 最も狩猟したモンスターを見つける
            let mostHuntedMonster = '';
            let mostHuntedCount = 0;
            for (const [monster, count] of Object.entries(monsterCounts)) {
                if (count > mostHuntedCount) {
                    mostHuntedMonster = monster;
                    mostHuntedCount = count;
                }
            }

            // 最も使用した武器を見つける
            let mostUsedWeapon = '';
            let mostUsedCount = 0;
            for (const [weapon, count] of Object.entries(weaponCounts)) {
                if (count > mostUsedCount) {
                    mostUsedWeapon = weapon;
                    mostUsedCount = count;
                }
            }

            // 統計表示を更新
            document.getElementById('total-hunts').textContent = recordsData.length;
            document.getElementById('avg-time').textContent = avgTimeString;
            document.getElementById('most-hunted').textContent = `${mostHuntedMonster} (${mostHuntedCount}回)`;
            document.getElementById('most-used-weapon').textContent = `${mostUsedWeapon} (${mostUsedCount}回)`;

            // チャートを更新
            createMonsterChart(monsterCounts);
            createWeaponChart(weaponCounts);
        }

          // モンスターチャートの作成
          function createMonsterChart(monsterCounts) {
              const ctx = document.getElementById('monsters-chart').getContext('2d');

              // データを準備（上位5件）
              const sortedMonsters = Object.entries(monsterCounts)
                  .sort((a, b) => b[1] - a[1])
                  .slice(0, 5);

              const labels = sortedMonsters.map(item => item[0]);
              const data = sortedMonsters.map(item => item[1]);

              // 既存のチャートを破棄
              if (window.monstersChart) {
                  window.monstersChart.destroy();
              }

              // 新しいチャートを作成
              window.monstersChart = new Chart(ctx, {
                  type: 'bar',
                  data: {
                      labels: labels,
                      datasets: [{
                          label: '狩猟回数',
                          data: data,
                          backgroundColor: '#c39b60',
                          borderColor: '#8a5319',
                          borderWidth: 1
                      }]
                  },
                  options: {
                      responsive: true,
                      plugins: {
                          legend: {
                              display: false
                          },
                          tooltip: {
                              callbacks: {
                                  title: function(tooltipItem) {
                                      return tooltipItem[0].label;
                                  },
                                  label: function(context) {
                                      return `${context.raw}回`;
                                  }
                              }
                          }
                      },
                      scales: {
                          y: {
                              beginAtZero: true,
                              ticks: {
                                  precision: 0
                              }
                          }
                      }
                  }
              });
          }

          // 武器チャートの作成
          function createWeaponChart(weaponCounts) {
              const ctx = document.getElementById('weapons-chart').getContext('2d');

              // データを準備
              const labels = Object.keys(weaponCounts);
              const data = Object.values(weaponCounts);

              // 色の配列
              const backgroundColors = [
                  '#e7c78e', '#d4a76a', '#c39b60', '#b28c50', '#a17f40',
                  '#906f30', '#8a5319', '#794612', '#683a0b', '#572e05'
              ];

              // 既存のチャートを破棄
              if (window.weaponsChart) {
                  window.weaponsChart.destroy();
              }

              // 新しいチャートを作成
              window.weaponsChart = new Chart(ctx, {
                  type: 'doughnut',
                  data: {
                      labels: labels,
                      datasets: [{
                          data: data,
                          backgroundColor: backgroundColors.slice(0, labels.length),
                          borderColor: '#8a5319',
                          borderWidth: 1
                      }]
                  },
                  options: {
                      responsive: true,
                      plugins: {
                          legend: {
                              position: 'right',
                              labels: {
                                  boxWidth: 12,
                                  padding: 10
                              }
                          },
                          tooltip: {
                              callbacks: {
                                  label: function(context) {
                                      const label = context.label || '';
                                      const value = context.raw;
                                      const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                      const percentage = Math.round((value / total) * 100);
                                      return `${label}: ${value}回 (${percentage}%)`;
                                  }
                              }
                          }
                      }
                  }
              });
          }

          // 空のチャートを表示
          function createEmptyCharts() {
              const monstersCtx = document.getElementById('monsters-chart').getContext('2d');
              const weaponsCtx = document.getElementById('weapons-chart').getContext('2d');

              // 既存のチャートを破棄
              if (window.monstersChart) {
                  window.monstersChart.destroy();
              }
              if (window.weaponsChart) {
                  window.weaponsChart.destroy();
              }

              // 空のモンスターチャート
              window.monstersChart = new Chart(monstersCtx, {
                  type: 'bar',
                  data: {
                      labels: ['データなし'],
                      datasets: [{
                          label: '狩猟回数',
                          data: [0],
                          backgroundColor: '#c39b60'
                      }]
                  },
                  options: {
                      responsive: true,
                      plugins: {
                          legend: {
                              display: false
                          }
                      },
                      scales: {
                          y: {
                              beginAtZero: true
                          }
                      }
                  }
              });

              // 空の武器チャート
              window.weaponsChart = new Chart(weaponsCtx, {
                  type: 'doughnut',
                  data: {
                      labels: ['データなし'],
                      datasets: [{
                          data: [1],
                          backgroundColor: ['#e7c78e']
                      }]
                  },
                  options: {
                      responsive: true,
                      plugins: {
                          legend: {
                              position: 'right'
                          }
                      }
                  }
              });
          }

        // フィルターパネルの表示/非表示切り替え
        function toggleFilterPanel() {
            const filterPanel = document.getElementById('filter-panel');
            if (filterPanel.style.display === 'none') {
                filterPanel.style.display = 'block';
            } else {
                filterPanel.style.display = 'none';
            }
        }

        // Base64エンコード（非ASCII文字対応版）
        function utf8_to_b64(str) {
            return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
                return String.fromCharCode('0x' + p1);
            }));
        }

        // Base64デコード（非ASCII文字対応版）
        function b64_to_utf8(str) {
            return decodeURIComponent(atob(str).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
        }

        // チェックリストを更新
        function updateChecklist() {
            const container = document.getElementById('checklist-container');
            const filter = document.getElementById('checklist-filter').value;

            // 攻略済みモンスターのセット
            const completedMonsters = new Set();
            recordsData.forEach(record => {
                completedMonsters.add(record.monster);
            });

            // モンスターごとのベストタイム
            const monsterBestTimes = {};
            recordsData.forEach(record => {
                if (!monsterBestTimes[record.monster] || record.timeValue < monsterBestTimes[record.monster].timeValue) {
                    monsterBestTimes[record.monster] = record;
                }
            });

            // コンテナをクリア
            container.innerHTML = '';

            // モンスターリストをソート
            const sortedMonsters = [...monsters].sort();

            // 進捗率の計算
            const completionRate = Math.round((completedMonsters.size / monsters.length) * 100);
            document.getElementById('completion-rate').textContent = `${completionRate}%`;
            document.getElementById('progress-fill').style.width = `${completionRate}%`;

            // モンスターカードを生成
            sortedMonsters.forEach(monster => {
                const isCompleted = completedMonsters.has(monster);

                // フィルタリング
                if (filter === 'completed' && !isCompleted) return;
                if (filter === 'incomplete' && isCompleted) return;

                const card = document.createElement('div');
                card.className = `monster-card ${isCompleted ? 'completed' : ''}`;

                let timeInfo = '';
                let weaponInfo = '';

                if (isCompleted && monsterBestTimes[monster]) {
                    const record = monsterBestTimes[monster];
                    timeInfo = `<div class="monster-time">ベストタイム: ${record.timeString}</div>`;
                    weaponInfo = `<div class="monster-weapon">使用武器: ${record.weapon}</div>`;
                }

                card.innerHTML = `
                    <div class="monster-name">
                        ${monster}
                        ${isCompleted ? '<i class="fas fa-check-circle completion-icon"></i>' : ''}
                    </div>
                    ${timeInfo}
                    ${weaponInfo}
                `;

                container.appendChild(card);
            });
        }
        // タブの切り替え
        function openTab(tabId) {
          // アクティブなタブを解除
          document.querySelectorAll('.tab-content').forEach(content => {
              content.classList.remove('active');
          });

          document.querySelectorAll('.tab-button').forEach(btn => {
              btn.classList.remove('active');
          });

          // 指定されたタブをアクティブに
          document.getElementById(tabId).classList.add('active');
          document.querySelector(`.tab-button[onclick="openTab('${tabId}')"]`).classList.add('active');

          // 統計タブが開かれたら統計データを更新
          if (tabId === 'statistics') {
              updateStatistics();
          }
          // ランキングタブが開かれたらランキングデータを更新
          else if (tabId === 'rankings') {
              updateRankings();
          }
          // チェックリストタブが開かれたらチェックリストを更新
          else if (tabId === 'checklist') {
              updateChecklist();
          }
          // トレンドタブが開かれたらトレンドを更新
          else if (tabId === 'trends') {
              initTrends();
          }
        }

        // 画像アップロード設定
        function setupImageUpload() {
            const imageUpload = document.getElementById('imageUpload');
            const imageUploadContainer = document.getElementById('imageUploadContainer');
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            const formPreviewImage = document.getElementById('formPreviewImage');
            const removeImage = document.getElementById('removeImage');

            imageUploadContainer.addEventListener('click', function() {
                imageUpload.click();
            });

            imageUpload.addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    imageFile = file;

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        formPreviewImage.src = e.target.result;
                        imageUploadContainer.style.display = 'none';
                        imagePreviewContainer.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });

            removeImage.addEventListener('click', function() {
                imageFile = null;
                formPreviewImage.src = '';
                imageUploadContainer.style.display = 'block';
                imagePreviewContainer.style.display = 'none';
                imageUpload.value = '';
            });
        }

        // 画像モーダル設定
        function setupImageModal() {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const closeButton = document.querySelector('.modal-close');

            // モーダルを閉じる
            closeButton.addEventListener('click', function() {
                modal.style.display = 'none';
            });

            // モーダル外をクリックしても閉じる
            window.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // 画像クリックでモーダルを表示（セキュリティ対策版）
        function showImageModal(imageUrl) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');

            // XSS対策：Base64データの場合のみ表示
            if (imageUrl.startsWith('data:image/')) {
                modalImage.src = imageUrl;
                modal.style.display = 'block';
            }
        }

        // モンスターセレクトボックスにオプションを追加
        function populateMonsterSelect() {
            const select = document.getElementById('monster-select');

            // 既存のオプションをクリア（最初の「選択してください」以外）
            while (select.options.length > 1) {
                select.remove(1);
            }

            // 並び替えてからオプションを追加
            monsters.sort().forEach(monster => {
                const option = document.createElement('option');
                option.value = monster;
                option.textContent = monster;
                select.appendChild(option);
            });
        }
        // トレンドチャートの初期化
        function initTrends() {
            // モンスター選択肢を更新
            const monsterSelect = document.getElementById('trend-monster');
            monsterSelect.innerHTML = '<option value="">モンスターを選択</option>';

            Array.from(uniqueMonsters).sort().forEach(monster => {
                const option = document.createElement('option');
                option.value = monster;
                option.textContent = monster;
                monsterSelect.appendChild(option);
            });

            // イベントリスナーを設定
            monsterSelect.addEventListener('change', updateTrendChart);
            document.getElementById('trend-weapon').addEventListener('change', updateTrendChart);
        }

        // トレンドチャートの更新
        function updateTrendChart() {
            const monsterSelect = document.getElementById('trend-monster');
            const weaponSelect = document.getElementById('trend-weapon');

            const selectedMonster = monsterSelect.value;
            const selectedWeapon = weaponSelect.value;

            const chartContainer = document.querySelector('.trend-chart-container');
            const emptyState = document.getElementById('trend-empty-state');

            // モンスターが選択されていない場合
            if (!selectedMonster) {
                chartContainer.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            // フィルタリング
            let filteredRecords = recordsData.filter(record => record.monster === selectedMonster);

            // 武器種のフィルタリング（指定されている場合）
            if (selectedWeapon) {
                filteredRecords = filteredRecords.filter(record => record.weapon === selectedWeapon);
            }

            // 記録がない場合
            if (filteredRecords.length === 0) {
                chartContainer.style.display = 'none';
                emptyState.style.display = 'block';
                emptyState.innerHTML = `
                    <i class="fas fa-chart-line empty-icon"></i>
                    <p>選択された条件に一致する記録がありません</p>
                `;
                return;
            }

            // 日付でソート
            filteredRecords.sort((a, b) => new Date(a.date) - new Date(b.date));

            // データの準備
            const labels = filteredRecords.map(record => {
                const date = new Date(record.date);
                return date.toLocaleDateString('ja-JP', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            });

            const timeData = filteredRecords.map(record => {
                // 分:秒.ミリ秒 から秒数に変換
                const parts = record.timeString.split(':');
                const minutesPart = parseInt(parts[0]);
                const secondsParts = parts[1].split('.');
                const secondsPart = parseInt(secondsParts[0]);
                const millisecondsPart = parseInt(secondsParts[1] || 0);

                // 合計秒数を計算（グラフ表示用）
                return minutesPart * 60 + secondsPart + (millisecondsPart / 100);
            });

            // 既存のチャートを破棄
            if (window.trendChart) {
                window.trendChart.destroy();
            }

            // チャートを表示
            chartContainer.style.display = 'block';
            emptyState.style.display = 'none';

            const ctx = document.getElementById('trend-chart').getContext('2d');

            // 新しいチャートを作成
            window.trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: selectedWeapon ? `${selectedMonster} (${selectedWeapon})` : selectedMonster,
                        data: timeData,
                        backgroundColor: 'rgba(195, 155, 96, 0.2)',
                        borderColor: '#8a5319',
                        borderWidth: 2,
                        pointBackgroundColor: '#c39b60',
                        pointRadius: 5,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'タイムの推移',
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const minutes = Math.floor(value / 60);
                                    const seconds = Math.floor(value % 60);
                                    const milliseconds = Math.round((value % 1) * 100);
                                    return `タイム: ${minutes}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(2, '0')}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            reverse: true, // 時間が短いほど上に表示
                            title: {
                                display: true,
                                text: 'クリアタイム（秒）'
                            },
                            ticks: {
                                callback: function(value) {
                                    const minutes = Math.floor(value / 60);
                                    const seconds = Math.floor(value % 60);
                                    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '日付'
                            }
                        }
                    }
                }
            });
        }
        // フィルター用のセレクトボックスを更新
        function updateFilterSelects() {
            // ユニーク値のセットを初期化
            uniqueMonsters = new Set();
            uniqueStages = new Set();
            uniqueTags = new Set();
            recordsData.forEach(record => {
                if (record.tags && Array.isArray(record.tags)) {
                    record.tags.forEach(tag => {
                        if (tag) uniqueTags.add(tag);
                    });
                }
            });
            // 現在のデータからユニーク値を収集
            recordsData.forEach(record => {
                uniqueMonsters.add(record.monster);
                if (record.stage) uniqueStages.add(record.stage);
            });

            // モンスターフィルターを更新
            const monsterFilter = document.getElementById('filter-monster');
            monsterFilter.innerHTML = '<option value="">モンスター（全て）</option>';

            Array.from(uniqueMonsters).sort().forEach(monster => {
                const option = document.createElement('option');
                option.value = monster;
                option.textContent = monster;
                monsterFilter.appendChild(option);
            });

            // ステージフィルターを更新
            const stageFilter = document.getElementById('filter-stage');
            stageFilter.innerHTML = '<option value="">ステージ（全て）</option>';

            Array.from(uniqueStages).sort().forEach(stage => {
                const option = document.createElement('option');
                option.value = stage;
                option.textContent = stage;
                stageFilter.appendChild(option);
            });

            // タグフィルターを更新
            const tagFilter = document.getElementById('filter-tag');
            tagFilter.innerHTML = '<option value="">タグ（全て）</option>';

            Array.from(uniqueTags).sort().forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                option.textContent = tag;
                tagFilter.appendChild(option);
            });
        }

        // 日付をフォーマット
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ランキングタブの切り替え
        function openRankingTab(tabId) {
            // アクティブなタブを解除
            document.querySelectorAll('.ranking-content').forEach(content => {
                content.classList.remove('active');
            });

            document.querySelectorAll('.ranking-tabs .tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // 指定されたタブをアクティブに
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.ranking-tabs .tab-button[onclick="openRankingTab('${tabId}')"]`).classList.add('active');

            // ランキングデータを更新
            updateRankings();
        }

        // ランキングデータの生成と表示
        function updateRankings() {
            // モンスター別ランキング
            const monsterRankings = {};

            // 各モンスターについて最速記録を探す
            recordsData.forEach(record => {
                const key = record.monster;
                if (!monsterRankings[key] || record.timeValue < monsterRankings[key].timeValue) {
                    monsterRankings[key] = record;
                }
            });

            // モンスター別ランキングテーブルを更新
            const monsterTable = document.getElementById('monster-ranking-table').querySelector('tbody');
            monsterTable.innerHTML = '';

            // モンスター配列を作成し、タイムでソート
            const sortedMonsters = Object.values(monsterRankings).sort((a, b) => a.timeValue - b.timeValue);

            sortedMonsters.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.monster}</td>
                    <td>${record.timeString}</td>
                    <td>${record.weapon}</td>
                    <td>${record.date ? formatDate(record.date) : '-'}</td>
                    <td>
                        <span class="action-btn share" onclick="shareRecord('${record.id}')">
                            <i class="fas fa-share-alt"></i>
                        </span>
                    </td>
                `;
                monsterTable.appendChild(row);
            });

            // 武器種別ランキング
            const weaponRankings = {};

            // 各武器種について最速記録を探す
            recordsData.forEach(record => {
                const key = record.weapon;
                if (!weaponRankings[key] || record.timeValue < weaponRankings[key].timeValue) {
                    weaponRankings[key] = record;
                }
            });

            // 武器種別ランキングテーブルを更新
            const weaponTable = document.getElementById('weapon-ranking-table').querySelector('tbody');
            weaponTable.innerHTML = '';

            // 武器種配列を作成し、タイムでソート
            const sortedWeapons = Object.values(weaponRankings).sort((a, b) => a.timeValue - b.timeValue);

            sortedWeapons.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.weapon}</td>
                    <td>${record.monster}</td>
                    <td>${record.timeString}</td>
                    <td>${record.date ? formatDate(record.date) : '-'}</td>
                    <td>
                        <span class="action-btn share" onclick="shareRecord('${record.id}')">
                            <i class="fas fa-share-alt"></i>
                        </span>
                    </td>
                `;
                weaponTable.appendChild(row);
            });
            // モンスター×武器種ランキング
            updateCombinedRanking();

            // ステージ別ランキング
            updateStageRanking();

            // クエスト別ランキング
            updateQuestRanking();

            // フィルターの更新
            updateRankingFilters();
        }
        // モンスター×武器種の組み合わせランキング
        function updateCombinedRanking() {
            const combinedRankings = {};

            // 各モンスター×武器種の組み合わせについて最速記録を探す
            recordsData.forEach(record => {
                const key = `${record.monster}_${record.weapon}`;
                if (!combinedRankings[key] || record.timeValue < combinedRankings[key].timeValue) {
                    combinedRankings[key] = record;
                }
            });

            // ランキングテーブルを更新
            const combinedTable = document.getElementById('combined-ranking-table').querySelector('tbody');
            combinedTable.innerHTML = '';

            // フィルター
            const monsterFilter = document.getElementById('combined-monster-filter').value;

            // 記録をソート
            let sortedRecords = Object.values(combinedRankings);

            // モンスターでフィルタリング（指定されている場合）
            if (monsterFilter) {
                sortedRecords = sortedRecords.filter(record => record.monster === monsterFilter);
            }

            // タイムでソート
            sortedRecords.sort((a, b) => a.timeValue - b.timeValue);

            // テーブルに表示
            sortedRecords.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.monster}</td>
                    <td>${record.weapon}</td>
                    <td>${record.timeString}</td>
                    <td>${record.date ? formatDate(record.date) : '-'}</td>
                    <td>
                        <span class="action-btn share" onclick="shareRecord('${record.id}')">
                            <i class="fas fa-share-alt"></i>
                        </span>
                    </td>
                `;
                combinedTable.appendChild(row);
            });
        }

        // ステージ別ランキング
        function updateStageRanking() {
            const stageRankings = {};

            // 各ステージについて最速記録を探す
            recordsData.forEach(record => {
                if (!record.stage) return;

                const key = record.stage;
                if (!stageRankings[key] || record.timeValue < stageRankings[key].timeValue) {
                    stageRankings[key] = record;
                }
            });

            // ランキングテーブルを更新
            const stageTable = document.getElementById('stage-ranking-table').querySelector('tbody');
            stageTable.innerHTML = '';

            // 記録をソート
            const sortedRecords = Object.values(stageRankings).sort((a, b) => a.timeValue - b.timeValue);

            // テーブルに表示
            sortedRecords.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.stage}</td>
                    <td>${record.monster}</td>
                    <td>${record.weapon}</td>
                    <td>${record.timeString}</td>
                    <td>${record.date ? formatDate(record.date) : '-'}</td>
                    <td>
                        <span class="action-btn share" onclick="shareRecord('${record.id}')">
                            <i class="fas fa-share-alt"></i>
                        </span>
                    </td>
                `;
                stageTable.appendChild(row);
            });
        }

        // クエストタイプ別ランキング
        function updateQuestRanking() {
            const questRankings = {};

            // 各クエストタイプについて最速記録を探す
            recordsData.forEach(record => {
                const questType = record.questType || '通常';

                const key = questType;
                if (!questRankings[key] || record.timeValue < questRankings[key].timeValue) {
                    questRankings[key] = record;
                }
            });

            // ランキングテーブルを更新
            const questTable = document.getElementById('quest-ranking-table').querySelector('tbody');
            questTable.innerHTML = '';

            // 記録をソート
            const sortedRecords = Object.values(questRankings).sort((a, b) => a.timeValue - b.timeValue);

            // テーブルに表示
            sortedRecords.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.questType || '通常'}</td>
                    <td>${record.monster}</td>
                    <td>${record.weapon}</td>
                    <td>${record.timeString}</td>
                    <td>${record.date ? formatDate(record.date) : '-'}</td>
                    <td>
                        <span class="action-btn share" onclick="shareRecord('${record.id}')">
                            <i class="fas fa-share-alt"></i>
                        </span>
                    </td>
                `;
                questTable.appendChild(row);
            });
        }

        // ランキングのフィルターを更新
        function updateRankingFilters() {
            // モンスター×武器フィルターを更新
            const monsterFilter = document.getElementById('combined-monster-filter');
            monsterFilter.innerHTML = '<option value="">モンスターでフィルター</option>';

            Array.from(uniqueMonsters).sort().forEach(monster => {
                const option = document.createElement('option');
                option.value = monster;
                option.textContent = monster;
                monsterFilter.appendChild(option);
            });

            // イベントリスナーを設定
            monsterFilter.onchange = updateCombinedRanking;
        }
        // 記録をローカルストレージから読み込む
        function loadRecords() {
            // ローカルストレージからデータを取得
            const storedData = localStorage.getItem(STORAGE_KEY);

            if (storedData) {
                try {
                    recordsData = JSON.parse(storedData);
                    renderRecordsTable();
                    updateFilterSelects();
                } catch (e) {
                    console.error('保存されたデータの読み込みに失敗しました:', e);
                    recordsData = [];
                }
            } else {
                // Cookieからも確認
                const cookieData = getCookie(STORAGE_KEY);
                if (cookieData) {
                    try {
                        recordsData = JSON.parse(cookieData);
                        renderRecordsTable();
                        updateFilterSelects();
                    } catch (e) {
                        console.error('Cookieからのデータ読み込みに失敗しました:', e);
                        recordsData = [];
                    }
                }
            }
        }

        // テーマ設定を読み込む
        function loadThemePreference() {
          const isDarkMode = localStorage.getItem('mh-dark-mode') === 'true';
          if (isDarkMode) {
            document.body.classList.add('dark-mode');
            document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
          }
        }

        // テーマを切り替える
        function toggleTheme() {
          const body = document.body;
          const themeToggle = document.getElementById('themeToggle');

          body.classList.toggle('dark-mode');

          if (body.classList.contains('dark-mode')) {
            themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            localStorage.setItem('mh-dark-mode', 'true');
          } else {
            themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            localStorage.setItem('mh-dark-mode', 'false');
          }
        }

        // 記録をローカルストレージとCookieに保存
        function saveRecordsToStorage() {
            try {
                // LocalStorageに保存
                localStorage.setItem(STORAGE_KEY, JSON.stringify(recordsData));

                // Cookieにも保存（1年間有効）
                setCookie(STORAGE_KEY, JSON.stringify(recordsData), 365);
            } catch (e) {
                console.error('データの保存に失敗しました:', e);
                alert('データの保存に失敗しました。ブラウザのストレージ容量を確認してください。');
            }
        }

        // 新しい記録を保存
        async function saveRecord(e) {
            e.preventDefault();

            const monster = document.getElementById('monster-select').value;
            const weapon = document.getElementById('weapon-select').value;
            const questType = document.getElementById('quest-type').value;
            const stage = document.getElementById('stage-select').value;
            const strength = document.getElementById('strength').value;
            const minutes = parseInt(document.getElementById('time-minutes').value) || 0;
            const seconds = parseInt(document.getElementById('time-seconds').value) || 0;
            const milliseconds = parseInt(document.getElementById('time-milliseconds').value) || 0;
            const notes = document.getElementById('notes').value;

            // バリデーション
            if (!monster || !weapon || !stage) {
                alert('モンスター、武器種、ステージを選択してください');
                return;
            }

            // 時間を文字列に変換
            const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(2, '0')}`;

            // 時間を比較用に数値に変換（ミリ秒単位）
            const timeValue = (minutes * 60 * 1000) + (seconds * 1000) + milliseconds;

            // 新しい記録オブジェクト
            const newRecord = {
                id: Date.now().toString(), // ユニークなID
                monster,
                weapon,
                questType,
                stage,
                strength,
                timeString,
                timeValue,
                notes,
                hasImage: !!imageFile,
                tags: document.getElementById('tags').value.split(',').map(tag => tag.trim()).filter(tag => tag !== ''), // ここを追加
                date: new Date().toISOString()
            };

            // 画像がある場合は保存
            if (imageFile) {
                try {
                    // FileReaderを使って画像をBase64エンコード
                    const reader = new FileReader();
                    const imageDataPromise = new Promise((resolve) => {
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(imageFile);
                    });

                    const imageData = await imageDataPromise;
                    await saveImage(newRecord.id, imageData);
                } catch (error) {
                    console.error('画像の保存に失敗しました:', error);
                    // エラーメッセージをUIに表示
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'error-message';
                    errorMsg.textContent = '画像の保存に失敗しました。もう一度お試しください。';
                    document.getElementById('imagePreviewContainer').appendChild(errorMsg);
                    setTimeout(() => errorMsg.remove(), 3000);
                    return;
                }
            }

            // 記録を追加
            recordsData.push(newRecord);

            // データをソート（時間の早い順）
            recordsData.sort((a, b) => a.timeValue - b.timeValue);

            // データを保存
            saveRecordsToStorage();

            // フィルターセレクト更新
            updateFilterSelects();

            // テーブルを更新
            renderRecordsTable();

            // フォームをリセット
            document.getElementById('record-form').reset();

            // 画像プレビューをリセット
            imageFile = null;
            document.getElementById('imageUploadContainer').style.display = 'block';
            document.getElementById('imagePreviewContainer').style.display = 'none';
            document.getElementById('formPreviewImage').src = '';
            document.getElementById('imageUpload').value = '';

            // 統計情報を更新
            updateStatistics();

            // チェックリストを更新
            updateChecklist();
            // ランキングを更新
            updateRankings();

            // トレンドを更新（表示中の場合）
            if (document.getElementById('trends').classList.contains('active')) {
              updateTrendChart();
            }

            alert('記録が保存されました！');
        }

        // 記録テーブルを更新
        async function renderRecordsTable(filteredData) {
            const tableBody = document.querySelector('#records-table tbody');
            tableBody.innerHTML = '';

            const dataToRender = filteredData || recordsData;

            if (dataToRender.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="10" class="empty-state">
                        <div>
                            <i class="fas fa-scroll empty-icon"></i>
                            <p>記録がありません</p>
                            <p class="text-muted">新しい記録を追加してください</p>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
                return;
            }

            // 画像データを一度に取得
            const imagePromises = {};
            for (const record of dataToRender) {
                if (record.hasImage) {
                    imagePromises[record.id] = getImage(record.id);
                }
            }

            // すべての画像を並行して取得
            const imageData = {};
            await Promise.all(
                Object.entries(imagePromises).map(async ([id, promise]) => {
                    try {
                        imageData[id] = await promise;
                    } catch (error) {
                        console.error(`画像ID ${id} の取得に失敗しました:`, error);
                        imageData[id] = null;
                    }
                })
            );

            // 各行をレンダリング
            for (const record of dataToRender) {
                const row = document.createElement('tr');

                let imageCell = '<td>-</td>';

                if (record.hasImage && imageData[record.id]) {
                    const imageDataResult = imageData[record.id];
                    if (imageDataResult && typeof imageDataResult === 'string' && imageDataResult.startsWith('data:image/')) {
                        // エスケープ処理をして安全に表示
                        const escapedImageData = imageDataResult.replace(/"/g, '&quot;');
                        imageCell = `
                            <td>
                                <img src="${escapedImageData}" class="image-preview" alt="スクリーンショット" onclick="showImageModal('${escapedImageData}')">
                            </td>
                        `;
                    }
                }

                // 日付のフォーマット
                const formattedDate = record.date ? formatDate(record.date) : '-';

                // タグの表示を準備
                let tagsDisplay = '-';
                if (record.tags && record.tags.length > 0) {
                    tagsDisplay = record.tags.map(tag =>
                        `<span class="tag-badge">${tag}</span>`
                    ).join(' ');
                }

                row.innerHTML = `
                    <td>${record.monster}</td>
                    <td>${record.weapon}</td>
                    <td>${record.questType || '通常'}</td>
                    <td>${record.stage || '-'}</td>
                    <td>${record.strength || '-'}</td>
                    <td>${record.timeString}</td>
                    <td>${formattedDate}</td>
                    <td class="tags-cell">${tagsDisplay}</td>
                    ${imageCell}
                    <td class="actions-cell">
                        <span class="action-btn share" onclick="shareRecord('${record.id}')">
                            <i class="fas fa-share-alt"></i>
                        </span>
                        <span class="action-btn delete" onclick="deleteRecord('${record.id}')">
                            <i class="fas fa-trash-alt"></i>
                        </span>
                    </td>
                `;

                tableBody.appendChild(row);
            }
        }

        // 日付のフォーマットを修正（エラーハンドリング追加）
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return '無効な日付';
                }
                return date.toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                console.error('日付のフォーマットに失敗しました:', e);
                return '無効な日付';
            }
        }

        // 記録を検索
        function filterRecords() {
            const searchQuery = document.getElementById('search-input').value.toLowerCase();
            const monsterFilter = document.getElementById('filter-monster').value;
            const weaponFilter = document.getElementById('filter-weapon').value;
            const questFilter = document.getElementById('filter-quest').value;
            const stageFilter = document.getElementById('filter-stage').value;
            const tagFilter = document.getElementById('filter-tag').value;

            const filteredData = recordsData.filter(record => {
                // テキスト検索
                const matchesText = !searchQuery ||
                record.monster.toLowerCase().includes(searchQuery) ||
                record.weapon.toLowerCase().includes(searchQuery) ||
                (record.notes && record.notes.toLowerCase().includes(searchQuery)) ||
                (record.tags && record.tags.some(tag => tag.toLowerCase().includes(searchQuery)));

                // モンスターフィルター
                const matchesMonster = !monsterFilter || record.monster === monsterFilter;

                // 武器フィルター
                const matchesWeapon = !weaponFilter || record.weapon === weaponFilter;

                // クエストタイプフィルター
                const matchesQuest = !questFilter || record.questType === questFilter;

                // ステージフィルター
                const matchesStage = !stageFilter || record.stage === stageFilter;
                // タグフィルター
                const matchesTag = !tagFilter || (record.tags && record.tags.includes(tagFilter));  // ここを追加

                return matchesText && matchesMonster && matchesWeapon && matchesQuest && matchesStage && matchesTag;
            });

            renderRecordsTable(filteredData);
        }

        // 記録を削除
        async function deleteRecord(id) {
            if (confirm('この記録を削除してもよろしいですか？')) {
                const record = recordsData.find(r => r.id === id);

                // 画像がある場合は削除
                if (record && record.hasImage) {
                    try {
                        await deleteImage(id);
                    } catch (error) {
                        console.error('画像の削除に失敗しました:', error);
                    }
                }

                recordsData = recordsData.filter(record => record.id !== id);
                saveRecordsToStorage();

                // フィルターセレクト更新
                updateFilterSelects();

                renderRecordsTable();
            }
        }

        // JSONにエクスポート（画像含む）
        async function exportToJson() {
            if (recordsData.length === 0) {
                alert('エクスポートするデータがありません');
                return;
            }

            try {
                // 画像データをエクスポート
                const imageData = await exportAllImages();

                // JSONデータを作成
                const exportData = {
                    records: recordsData,
                    images: imageData
                };

                const jsonData = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `mh-timeattack-export-${new Date().toISOString().slice(0, 10)}.json`;
                a.click();

                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('エクスポート中にエラーが発生しました:', error);
                alert('データのエクスポートに失敗しました。');
            }
        }

        // JSONからインポート（画像含む）
        async function importFromJson() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];

            if (!file) {
                alert('インポートするファイルを選択してください');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);

                    if (!importedData.records || !Array.isArray(importedData.records)) {
                        throw new Error('無効なデータ形式です');
                    }

                    if (confirm('既存のデータにインポートしたデータを追加しますか？キャンセルを選択すると既存のデータは上書きされます。')) {
                        // 既存のデータに追加
                        recordsData = [...recordsData, ...importedData.records];
                    } else {
                        // 既存のデータを上書き
                        recordsData = importedData.records;
                    }

                    // 重複を削除
                    const uniqueIds = new Set();
                    recordsData = recordsData.filter(record => {
                        if (!record.id) record.id = Date.now().toString() + Math.random().toString(36).substr(2, 5);
                        if (uniqueIds.has(record.id)) return false;
                        uniqueIds.add(record.id);
                        return true;
                    });

                    // 時間でソート
                    recordsData.sort((a, b) => a.timeValue - b.timeValue);

                    // データを保存
                    saveRecordsToStorage();

                    // 画像データがある場合はインポート
                    if (importedData.images) {
                        await importAllImages(importedData.images);
                    }

                    // フィルターセレクト更新
                    updateFilterSelects();

                    // テーブルを更新
                    renderRecordsTable();

                    alert('データのインポートが完了しました');
                    fileInput.value = '';
                } catch (e) {
                    console.error('インポートエラー:', e);
                    alert('データのインポートに失敗しました。ファイル形式を確認してください。');
                }
            };
            reader.readAsText(file);
        }

        // 全データを削除
        async function clearAllData() {
            if (confirm('すべての記録データを削除します。この操作は元に戻せません。続行しますか？')) {
                try {
                    // IndexedDBの画像をすべて削除
                    await deleteAllImages();

                    // 記録データをクリア
                    recordsData = [];
                    saveRecordsToStorage();

                    // フィルターセレクト更新
                    updateFilterSelects();

                    renderRecordsTable();

                    alert('すべてのデータが削除されました');
                } catch (error) {
                    console.error('データ削除中にエラーが発生しました:', error);
                    alert('データの削除に失敗しました。');
                }
            }
        }

        // Cookieを設定
        function setCookie(name, value, days) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${encodeURIComponent(value)};expires=${expires.toUTCString()};path=/`;
        }

        // Cookieを取得
        function getCookie(name) {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    return decodeURIComponent(cookie.substring(name.length + 1));
                }
            }
            return null;
        }

        // ------共有機能------
        // 記録を共有する関数
        function shareRecord(recordId) {
            const record = recordsData.find(r => r.id === recordId);
            if (!record) return;

            // モーダルを作成
            const modal = document.createElement('div');
            modal.className = 'share-modal';
            modal.innerHTML = `
                <div class="share-modal-content">
                    <span class="share-modal-close">&times;</span>
                    <h3>記録を共有</h3>
                    <div class="share-details">
                        <p><strong>モンスター:</strong> ${record.monster}</p>
                        <p><strong>武器種:</strong> ${record.weapon}</p>
                        <p><strong>タイム:</strong> ${record.timeString}</p>
                        <p><strong>日付:</strong> ${formatDate(record.date)}</p>
                    </div>
                    <div class="share-options">
                        <button class="btn btn-secondary share-btn" id="copyShareLink">
                            <i class="fas fa-link"></i> リンクをコピー
                        </button>
                        <button class="btn btn-secondary share-btn" id="generateQR">
                            <i class="fas fa-qrcode"></i> QRコードを生成
                        </button>
                        <button class="btn btn-secondary share-btn" id="shareTwitter">
                            <i class="fab fa-twitter"></i> Twitterで共有
                        </button>
                    </div>
                    <div id="qrCodeContainer" class="qr-code-container"></div>
                    <div id="shareStatus" class="share-status"></div>
                </div>
            `;

            document.body.appendChild(modal);

            // モーダルを表示（DOMに追加された後に）
            setTimeout(() => {
                modal.classList.add('active');

                // ここでイベントリスナーを設定（DOM要素が確実に存在する）
                const closeBtn = modal.querySelector('.share-modal-close');
                closeBtn.onclick = () => {
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 300);
                };

                // リンクコピーボタンの処理
                const copyBtn = document.getElementById('copyShareLink');
                copyBtn.onclick = () => {
                    // 共有用の記録データを作成
                    const shareData = {
                        type: 'record',
                        data: record
                    };

                    // Base64エンコード（非ASCII文字対応）
                    const shareString = utf8_to_b64(JSON.stringify(shareData));
                    const shareUrl = `${window.location.href.split('?')[0]}?share=${shareString}`;

                    // クリップボードにコピー
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        document.getElementById('shareStatus').textContent = 'リンクをコピーしました！';
                        setTimeout(() => {
                            document.getElementById('shareStatus').textContent = '';
                        }, 2000);
                    }).catch(err => {
                        console.error('クリップボードへのコピーに失敗しました:', err);
                        // フォールバック: テキストフィールドを作成してコピー
                        const textArea = document.createElement('textarea');
                        textArea.value = shareUrl;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        document.getElementById('shareStatus').textContent = 'リンクをコピーしました！';
                        setTimeout(() => {
                            document.getElementById('shareStatus').textContent = '';
                        }, 2000);
                    });
                };

                // QRコード生成ボタンの処理
                const qrBtn = document.getElementById('generateQR');
                qrBtn.onclick = () => {
                    const qrContainer = document.getElementById('qrCodeContainer');
                    qrContainer.innerHTML = '';

                    try {
                        // 共有用の記録データを作成
                        const shareData = {
                            type: 'record',
                            data: record
                        };

                        // Base64エンコード（非ASCII文字対応）
                        const shareString = utf8_to_b64(JSON.stringify(shareData));
                        const shareUrl = `${window.location.href.split('?')[0]}?share=${shareString}`;

                        // QRコード生成
                        new QRCode(qrContainer, {
                            text: shareUrl,
                            width: 200,
                            height: 200,
                            colorDark: '#8a5319',
                            colorLight: '#ffffff',
                            correctLevel: QRCode.CorrectLevel.H
                        });

                        // 成功メッセージ
                        document.getElementById('shareStatus').textContent = 'QRコードを生成しました！';
                        setTimeout(() => {
                            document.getElementById('shareStatus').textContent = '';
                        }, 2000);
                    } catch (error) {
                        console.error('QRコード生成に失敗しました:', error);
                        document.getElementById('shareStatus').textContent = 'QRコード生成に失敗しました';
                    }
                };

                // Twitterで共有ボタンの処理
                const twitterBtn = document.getElementById('shareTwitter');
                twitterBtn.onclick = () => {
                    // 共有用の記録データを作成
                    const shareData = {
                        type: 'record',
                        data: record
                    };

                    // Base64エンコード（非ASCII文字対応）
                    const shareString = utf8_to_b64(JSON.stringify(shareData));

                    // 共有URLを生成
                    const shareUrl = `${window.location.href.split('?')[0]}?share=${shareString}`;

                    // ツイート本文
                    const text = `Monster Hunter Wilds(モンスターハンターワイルズ) Time Attack: ${record.monster} / ${record.weapon} / ${record.timeString}`;

                    // Twitter共有URL
                    const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(shareUrl)}`;
                    window.open(twitterUrl, '_blank');
                };
            }, 50); // 少し遅延させる
        }

        // 共有リンクを処理する関数
        function processShareLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const shareParam = urlParams.get('share');

            if (shareParam) {
                try {
                    // Base64デコード（非ASCII文字対応）
                    const shareData = JSON.parse(b64_to_utf8(shareParam));

                    if (shareData.type === 'record') {
                        const record = shareData.data;

                        // 共有された記録の詳細を表示するモーダルを作成
                        const modal = document.createElement('div');
                        modal.className = 'share-modal';
                        modal.innerHTML = `
                            <div class="share-modal-content">
                                <span class="share-modal-close">&times;</span>
                                <h3>共有された記録</h3>
                                <div class="share-details">
                                    <p><strong>モンスター:</strong> ${record.monster}</p>
                                    <p><strong>武器種:</strong> ${record.weapon}</p>
                                    <p><strong>クエストタイプ:</strong> ${record.questType || '通常'}</p>
                                    <p><strong>ステージ:</strong> ${record.stage || '-'}</p>
                                    <p><strong>タイム:</strong> ${record.timeString}</p>
                                    <p><strong>日付:</strong> ${formatDate(record.date)}</p>
                                    ${record.notes ? `<p><strong>メモ:</strong> ${record.notes}</p>` : ''}
                                    ${record.tags && record.tags.length > 0 ?
                                        `<p><strong>タグ:</strong> ${record.tags.map(tag =>
                                            `<span class="tag-badge">${tag}</span>`
                                        ).join(' ')}</p>` : ''}
                                </div>
                                <div class="share-options">
                                    <button class="btn btn-primary btn-block" id="importSharedRecord">
                                        この記録をインポート
                                    </button>
                                </div>
                            </div>
                        `;

                        document.body.appendChild(modal);

                        // モーダルを表示
                        setTimeout(() => {
                            modal.classList.add('active');

                            // 閉じるボタンの処理
                            const closeBtn = modal.querySelector('.share-modal-close');
                            closeBtn.onclick = () => {
                                modal.classList.remove('active');
                                setTimeout(() => modal.remove(), 300);

                                // URLからパラメータを削除
                                window.history.replaceState({}, document.title, window.location.pathname);
                            };

                            // インポートボタンの処理
                            const importBtn = document.getElementById('importSharedRecord');
                            importBtn.onclick = () => {
                                // 既存の記録に重複がないか確認
                                const isDuplicate = recordsData.some(r =>
                                    r.monster === record.monster &&
                                    r.weapon === record.weapon &&
                                    r.timeString === record.timeString &&
                                    r.date === record.date
                                );

                                if (isDuplicate) {
                                    if (!confirm('同じ記録が既に存在します。それでもインポートしますか？')) {
                                        return;
                                    }
                                }

                                // 記録を追加
                                const newRecord = {
                                    ...record,
                                    id: Date.now().toString(), // 新しいIDを割り当て
                                    hasImage: false // 共有された記録には画像がない
                                };

                                recordsData.push(newRecord);

                                // データをソート（時間の早い順）
                                recordsData.sort((a, b) => a.timeValue - b.timeValue);

                                // データを保存
                                saveRecordsToStorage();

                                // フィルターセレクト更新
                                updateFilterSelects();

                                // テーブルを更新
                                renderRecordsTable();

                                // 統計を更新
                                updateStatistics();

                                // チェックリストを更新
                                updateChecklist();

                                // ランキングを更新
                                updateRankings();

                                // モーダルを閉じる
                                modal.classList.remove('active');
                                setTimeout(() => modal.remove(), 300);

                                // URLからパラメータを削除
                                window.history.replaceState({}, document.title, window.location.pathname);

                                alert('記録がインポートされました！');
                            };
                        }, 50);
                    }
                } catch (e) {
                    console.error('共有データの解析に失敗しました:', e);
                }
            }
        }

        // ------自動バックアップ機能------
        // バックアップ設定
        const BACKUP_SETTINGS_KEY = 'mh-backup-settings';
        let backupSettings = {
            enabled: false,
            interval: 'daily', // 'daily', 'weekly', 'monthly'
            lastBackup: null
        };

        // バックアップ設定を読み込む
        function loadBackupSettings() {
            const storedSettings = localStorage.getItem(BACKUP_SETTINGS_KEY);
            if (storedSettings) {
                try {
                    backupSettings = JSON.parse(storedSettings);
                } catch (e) {
                    console.error('バックアップ設定の読み込みに失敗しました:', e);
                }
            }

            // バックアップ設定画面を更新
            updateBackupSettingsUI();
        }

        // バックアップ設定を保存
        function saveBackupSettings() {
            localStorage.setItem(BACKUP_SETTINGS_KEY, JSON.stringify(backupSettings));

            // バックアップタイマーを設定
            setupBackupTimer();
        }

        // バックアップ設定画面を更新
        function updateBackupSettingsUI() {
            document.getElementById('backup-enabled').checked = backupSettings.enabled;
            document.getElementById('backup-interval').value = backupSettings.interval;

            const lastBackupElement = document.getElementById('last-backup-date');
            if (backupSettings.lastBackup) {
                lastBackupElement.textContent = formatDate(backupSettings.lastBackup);
            } else {
                lastBackupElement.textContent = 'なし';
            }
        }

        // バックアップタイマーを設定
        function setupBackupTimer() {
            // 既存のタイマーをクリア
            if (window.backupTimer) {
                clearTimeout(window.backupTimer);
            }

            if (!backupSettings.enabled) return;

            // 次回のバックアップ時刻を計算
            let nextBackupTime;
            const now = new Date();

            if (backupSettings.lastBackup) {
                const lastBackup = new Date(backupSettings.lastBackup);

                if (backupSettings.interval === 'daily') {
                    // 毎日同じ時刻
                    nextBackupTime = new Date(lastBackup);
                    nextBackupTime.setDate(nextBackupTime.getDate() + 1);
                } else if (backupSettings.interval === 'weekly') {
                    // 毎週同じ曜日・時刻
                    nextBackupTime = new Date(lastBackup);
                    nextBackupTime.setDate(nextBackupTime.getDate() + 7);
                } else if (backupSettings.interval === 'monthly') {
                    // 毎月同じ日・時刻
                    nextBackupTime = new Date(lastBackup);
                    nextBackupTime.setMonth(nextBackupTime.getMonth() + 1);
                }

                // 既に過ぎている場合は今すぐ実行
                if (nextBackupTime < now) {
                    nextBackupTime = now;
                }
            } else {
                // 初回は1分後に実行
                nextBackupTime = new Date(now.getTime() + 60000);
            }

            // タイマーを設定
            const timeUntilBackup = nextBackupTime.getTime() - now.getTime();
            window.backupTimer = setTimeout(performBackup, timeUntilBackup);

            console.log(`次回のバックアップ: ${nextBackupTime.toLocaleString()}`);
        }

        // バックアップを実行
        async function performBackup() {
            if (!backupSettings.enabled || recordsData.length === 0) return;

            try {
                // 画像データをエクスポート
                const imageData = await exportAllImages();

                // JSONデータを作成
                const exportData = {
                    records: recordsData,
                    images: imageData
                };

                const jsonData = JSON.stringify(exportData);
                const blob = new Blob([jsonData], { type: 'application/json' });

                // ファイル名を生成
                const date = new Date();
                const dateString = date.toISOString().slice(0, 10);
                const fileName = `mh-timeattack-backup-${dateString}.json`;

                // ダウンロードを自動実行
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // 最終バックアップ日時を更新
                backupSettings.lastBackup = date.toISOString();
                saveBackupSettings();

                // バックアップ設定画面の表示を更新
                updateBackupSettingsUI();

                // 通知
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('自動バックアップ', {
                        body: 'モンハンタイムアタックのデータが自動バックアップされました。',
                        icon: './images/logo.png'
                    });
                }

                console.log('バックアップが完了しました:', dateString);
            } catch (error) {
                console.error('バックアップ中にエラーが発生しました:', error);
            }

            // 次回のバックアップタイマーを設定
            setupBackupTimer();
        }
        // プロフィール管理とプリセット機能の追加

        // プロフィール設定
        const PROFILE_STORAGE_KEY = 'mh-hunter-profile';
        let profileData = {
            hunterName: '',
            hunterRank: 1,
            platform: 'PS5', // PS5またはPC
            playerId: '',
            mainWeapon: '',
            playTime: 0,
            bio: '',
            avatarData: null // Base64画像データ
        };

        // 装備プリセット管理
        const PRESET_STORAGE_KEY = 'mh-equipment-presets';
        let equipmentPresets = [];

        // プロフィールデータを読み込む
        function loadProfile() {
            const storedProfile = localStorage.getItem(PROFILE_STORAGE_KEY);
            if (storedProfile) {
                try {
                    profileData = JSON.parse(storedProfile);
                } catch (e) {
                    console.error('プロフィールデータの読み込みに失敗しました:', e);
                }
            }
            // UI更新
            updateProfileUI();
        }

        // プロフィールデータを保存する
        function saveProfile() {
            try {
                localStorage.setItem(PROFILE_STORAGE_KEY, JSON.stringify(profileData));
            } catch (e) {
                console.error('プロフィールデータの保存に失敗しました:', e);
                alert('プロフィールの保存に失敗しました。ブラウザのストレージ容量を確認してください。');
            }
        }

        // プロフィールUIを更新
        function updateProfileUI() {
            if (document.getElementById('hunter-name')) {
                document.getElementById('hunter-name').value = profileData.hunterName;
            }
            if (document.getElementById('hunter-rank')) {
                document.getElementById('hunter-rank').value = profileData.hunterRank;
            }
            if (document.getElementById('platform')) {
                document.getElementById('platform').value = profileData.platform;
            }
            if (document.getElementById('player-id')) {
                document.getElementById('player-id').value = profileData.playerId;
            }
            if (document.getElementById('main-weapon')) {
                document.getElementById('main-weapon').value = profileData.mainWeapon;
            }
            if (document.getElementById('play-time')) {
                document.getElementById('play-time').value = profileData.playTime;
            }
            if (document.getElementById('bio')) {
                document.getElementById('bio').value = profileData.bio;
            }
            if (document.getElementById('profile-avatar') && profileData.avatarData) {
                document.getElementById('profile-avatar').src = profileData.avatarData;
                document.getElementById('profile-avatar').style.display = 'block';
            }

            // ヘッダープロフィール情報も更新
            updateHeaderProfile();
        }

        // ヘッダーのプロフィール表示を更新
        function updateHeaderProfile() {
            const profileElement = document.getElementById('header-profile');
            if (profileElement) {
                if (profileData.hunterName) {
                    profileElement.textContent = `${profileData.hunterName} HR${profileData.hunterRank}`;
                    profileElement.style.display = 'block';
                } else {
                    profileElement.style.display = 'none';
                }
            }
        }

        // プリセットを読み込む
        function loadPresets() {
            const storedPresets = localStorage.getItem(PRESET_STORAGE_KEY);
            if (storedPresets) {
                try {
                    equipmentPresets = JSON.parse(storedPresets);
                } catch (e) {
                    console.error('プリセットデータの読み込みに失敗しました:', e);
                }
            }
        }

        // プリセットを保存する
        function savePresets() {
            try {
                localStorage.setItem(PRESET_STORAGE_KEY, JSON.stringify(equipmentPresets));
            } catch (e) {
                console.error('プリセットデータの保存に失敗しました:', e);
                alert('プリセットの保存に失敗しました。ブラウザのストレージ容量を確認してください。');
            }
        }

        // プリセットを追加
        function addPreset(preset) {
            // IDの割り当て
            preset.id = Date.now().toString();
            equipmentPresets.push(preset);
            savePresets();
            return preset;
        }

        // プリセットを更新
        function updatePreset(id, updatedPreset) {
            const index = equipmentPresets.findIndex(preset => preset.id === id);
            if (index !== -1) {
                equipmentPresets[index] = {...equipmentPresets[index], ...updatedPreset};
                savePresets();
                return true;
            }
            return false;
        }

        // プリセットを削除
        function deletePreset(id) {
            const initialLength = equipmentPresets.length;
            equipmentPresets = equipmentPresets.filter(preset => preset.id !== id);
            if (initialLength !== equipmentPresets.length) {
                savePresets();
                return true;
            }
            return false;
        }

        // プリセット一覧を取得
        function getPresets() {
            return [...equipmentPresets];
        }

        // プリセットをIDで取得
        function getPresetById(id) {
            return equipmentPresets.find(preset => preset.id === id);
        }

        // 装備セット情報からプリセットを作成
        function createPresetFromEquipment(name, weapon, head, body, arms, waist, legs, charm, decorations, skills) {
            return {
                id: Date.now().toString(),
                name: name,
                created: new Date().toISOString(),
                lastUsed: new Date().toISOString(),
                equipment: {
                    weapon: weapon ? { id: weapon.id, name: weapon.name, type: weapon.type } : null,
                    head: head ? { id: head.id, name: head.name } : null,
                    body: body ? { id: body.id, name: body.name } : null,
                    arms: arms ? { id: arms.id, name: arms.name } : null,
                    waist: waist ? { id: waist.id, name: waist.name } : null,
                    legs: legs ? { id: legs.id, name: legs.name } : null,
                    charm: charm ? { id: charm.id, name: charm.name } : null,
                },
                decorations: decorations || {},
                skills: skills || [],
                notes: ""
            };
        }

        // プリセットリスト更新
        function updatePresetList(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = '';

            if (equipmentPresets.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-scroll empty-icon"></i><p>プリセットがありません</p><p class="text-muted">新しいプリセットを追加してください</p></div>';
                return;
            }

            // プリセットをソート（最後に使用した順）
            const sortedPresets = [...equipmentPresets].sort((a, b) =>
                new Date(b.lastUsed || b.created) - new Date(a.lastUsed || a.created)
            );

            sortedPresets.forEach(preset => {
                const presetCard = document.createElement('div');
                presetCard.className = 'preset-card card';

                // スキル一覧を構築
                let skillsList = '';
                if (preset.skills && preset.skills.length > 0) {
                    skillsList = preset.skills.map(skill =>
                        `<span class="tag-badge">${skill.name} Lv${skill.level}</span>`
                    ).join(' ');
                } else {
                    skillsList = '<span class="text-muted">スキル情報なし</span>';
                }

                // 武器種アイコンの選択
                let weaponIcon = 'fa-question';
                if (preset.equipment.weapon) {
                    const weaponType = preset.equipment.weapon.type;
                    if (weaponType.includes('大剣')) weaponIcon = 'fa-khanda';
                    else if (weaponType.includes('太刀')) weaponIcon = 'fa-wind';
                    else if (weaponType.includes('片手剣')) weaponIcon = 'fa-sword';
                    else if (weaponType.includes('双剣')) weaponIcon = 'fa-swords';
                    else if (weaponType.includes('ハンマー')) weaponIcon = 'fa-hammer';
                    else if (weaponType.includes('狩猟笛')) weaponIcon = 'fa-music';
                    else if (weaponType.includes('ランス')) weaponIcon = 'fa-splotch';
                    else if (weaponType.includes('ガンランス')) weaponIcon = 'fa-rocket';
                    else if (weaponType.includes('スラッシュアックス')) weaponIcon = 'fa-axe';
                    else if (weaponType.includes('チャージアックス')) weaponIcon = 'fa-bolt';
                    else if (weaponType.includes('操虫棍')) weaponIcon = 'fa-bug';
                    else if (weaponType.includes('ライトボウガン')) weaponIcon = 'fa-gun';
                    else if (weaponType.includes('ヘヴィボウガン')) weaponIcon = 'fa-bazooka';
                    else if (weaponType.includes('弓')) weaponIcon = 'fa-bow-arrow';
                }

                presetCard.innerHTML = `
                    <div class="card-header">
                        <div>
                            <i class="fas ${weaponIcon}"></i> ${preset.name}
                        </div>
                        <div class="preset-actions">
                            <span class="action-btn" onclick="editPreset('${preset.id}')">
                                <i class="fas fa-edit"></i>
                            </span>
                            <span class="action-btn delete" onclick="confirmDeletePreset('${preset.id}')">
                                <i class="fas fa-trash-alt"></i>
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="preset-equipment">
                            <div><strong>武器:</strong> ${preset.equipment.weapon ? preset.equipment.weapon.name : '未設定'}</div>
                            <div><strong>頭:</strong> ${preset.equipment.head ? preset.equipment.head.name : '未設定'}</div>
                            <div><strong>胴:</strong> ${preset.equipment.body ? preset.equipment.body.name : '未設定'}</div>
                            <div><strong>腕:</strong> ${preset.equipment.arms ? preset.equipment.arms.name : '未設定'}</div>
                            <div><strong>腰:</strong> ${preset.equipment.waist ? preset.equipment.waist.name : '未設定'}</div>
                            <div><strong>脚:</strong> ${preset.equipment.legs ? preset.equipment.legs.name : '未設定'}</div>
                            <div><strong>護石:</strong> ${preset.equipment.charm ? preset.equipment.charm.name : '未設定'}</div>
                        </div>
                        <div class="preset-skills">
                            <div><strong>発動スキル:</strong></div>
                            <div class="skills-container">
                                ${skillsList}
                            </div>
                        </div>
                        <div class="preset-footer">
                            <button class="btn btn-primary btn-sm" onclick="applyPreset('${preset.id}')">使用する</button>
                            <button class="btn btn-secondary btn-sm" onclick="sharePreset('${preset.id}')">共有</button>
                        </div>
                    </div>
                `;

                container.appendChild(presetCard);
            });
        }

        // プリセット編集モーダル表示
        function editPreset(presetId) {
            const preset = getPresetById(presetId);
            if (!preset) return;

            // モーダルを作成・表示
            const modal = document.createElement('div');
            modal.className = 'share-modal active';
            modal.innerHTML = `
                <div class="share-modal-content">
                    <span class="share-modal-close">&times;</span>
                    <h3>プリセット編集</h3>
                    <div class="form-group">
                        <label for="preset-name-edit" class="form-label">プリセット名:</label>
                        <input type="text" id="preset-name-edit" class="form-control" value="${preset.name}">
                    </div>
                    <div class="form-group">
                        <label for="preset-notes-edit" class="form-label">メモ:</label>
                        <textarea id="preset-notes-edit" class="form-control" rows="3">${preset.notes || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <button id="save-preset-edit" class="btn btn-primary btn-block">保存</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // 閉じるボタンの処理
            const closeBtn = modal.querySelector('.share-modal-close');
            closeBtn.onclick = () => {
                modal.classList.remove('active');
                setTimeout(() => modal.remove(), 300);
            };

            // 保存ボタンの処理
            const saveBtn = document.getElementById('save-preset-edit');
            saveBtn.onclick = () => {
                const newName = document.getElementById('preset-name-edit').value.trim();
                const newNotes = document.getElementById('preset-notes-edit').value.trim();

                if (!newName) {
                    alert('プリセット名を入力してください');
                    return;
                }

                const updatedPreset = {
                    ...preset,
                    name: newName,
                    notes: newNotes
                };

                if (updatePreset(presetId, updatedPreset)) {
                    updatePresetList('presets-container');
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 300);
                }
            };
        }

        // プリセット削除確認
        function confirmDeletePreset(presetId) {
            if (confirm('このプリセットを削除してもよろしいですか？')) {
                if (deletePreset(presetId)) {
                    updatePresetList('presets-container');
                }
            }
        }

        // プリセットを適用
        function applyPreset(presetId) {
            const preset = getPresetById(presetId);
            if (!preset) return;

            // 最終使用日時を更新
            preset.lastUsed = new Date().toISOString();
            updatePreset(presetId, preset);

            // 記録フォームに装備情報を設定
            if (document.getElementById('preset-select')) {
                document.getElementById('preset-select').value = presetId;
            }

            // 適用メッセージを表示
            const message = document.createElement('div');
            message.className = 'toast-message';
            message.innerHTML = `<i class="fas fa-check-circle"></i> プリセット「${preset.name}」を適用しました`;
            document.body.appendChild(message);

            setTimeout(() => {
                message.classList.add('toast-show');
                setTimeout(() => {
                    message.classList.remove('toast-show');
                    setTimeout(() => message.remove(), 300);
                }, 3000);
            }, 10);
        }

        // プリセットの共有
        function sharePreset(presetId) {
            const preset = getPresetById(presetId);
            if (!preset) return;

            // 共有データを作成
            const shareData = {
                type: 'preset',
                data: preset
            };

            // Base64エンコード
            const shareString = utf8_to_b64(JSON.stringify(shareData));
            const shareUrl = `${window.location.href.split('?')[0]}?share=${shareString}`;

            // 共有モーダルを表示
            const modal = document.createElement('div');
            modal.className = 'share-modal active';
            modal.innerHTML = `
                <div class="share-modal-content">
                    <span class="share-modal-close">&times;</span>
                    <h3>装備プリセット共有</h3>
                    <div class="share-details">
                        <p><strong>プリセット名:</strong> ${preset.name}</p>
                        <p><strong>武器:</strong> ${preset.equipment.weapon ? preset.equipment.weapon.name : '未設定'}</p>
                    </div>
                    <div class="share-options">
                        <button class="btn btn-secondary share-btn" id="copyShareLink">
                            <i class="fas fa-link"></i> リンクをコピー
                        </button>
                        <button class="btn btn-secondary share-btn" id="generateQR">
                            <i class="fas fa-qrcode"></i> QRコードを生成
                        </button>
                        <button class="btn btn-secondary share-btn" id="shareTwitter">
                            <i class="fab fa-twitter"></i> Twitterで共有
                        </button>
                    </div>
                    <div id="qrCodeContainer" class="qr-code-container"></div>
                    <div id="shareStatus" class="share-status"></div>
                </div>
            `;

            document.body.appendChild(modal);

            // 閉じるボタンの処理
            const closeBtn = modal.querySelector('.share-modal-close');
            closeBtn.onclick = () => {
                modal.classList.remove('active');
                setTimeout(() => modal.remove(), 300);
            };

            // リンクコピーボタンの処理
            const copyBtn = document.getElementById('copyShareLink');
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    document.getElementById('shareStatus').textContent = 'リンクをコピーしました！';
                    setTimeout(() => {
                        document.getElementById('shareStatus').textContent = '';
                    }, 2000);
                }).catch(err => {
                    console.error('クリップボードへのコピーに失敗しました:', err);
                    const textArea = document.createElement('textarea');
                    textArea.value = shareUrl;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    document.getElementById('shareStatus').textContent = 'リンクをコピーしました！';
                    setTimeout(() => {
                        document.getElementById('shareStatus').textContent = '';
                    }, 2000);
                });
            };

            // QRコード生成ボタンの処理
            const qrBtn = document.getElementById('generateQR');
            qrBtn.onclick = () => {
                const qrContainer = document.getElementById('qrCodeContainer');
                qrContainer.innerHTML = '';

                try {
                    new QRCode(qrContainer, {
                        text: shareUrl,
                        width: 200,
                        height: 200,
                        colorDark: '#8a5319',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.H
                    });

                    document.getElementById('shareStatus').textContent = 'QRコードを生成しました！';
                    setTimeout(() => {
                        document.getElementById('shareStatus').textContent = '';
                    }, 2000);
                } catch (error) {
                    console.error('QRコード生成に失敗しました:', error);
                    document.getElementById('shareStatus').textContent = 'QRコード生成に失敗しました';
                }
            };

            // Twitterで共有ボタンの処理
            const twitterBtn = document.getElementById('shareTwitter');
            twitterBtn.onclick = () => {
                // スキル情報をテキスト化
                let skillsText = '';
                if (preset.skills && preset.skills.length > 0) {
                    const skillNames = preset.skills.map(skill => `${skill.name}Lv${skill.level}`).join('/');
                    skillsText = `【スキル: ${skillNames}】`;
                }

                // ツイート本文
                const text = `モンハンワイルズ装備プリセット「${preset.name}」${skillsText}`;

                // Twitter共有URL
                const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(shareUrl)}`;
                window.open(twitterUrl, '_blank');
            };
        }

        // プロフィール編集モーダル表示
        function showProfileModal() {
            // モーダルを作成・表示
            const modal = document.createElement('div');
            modal.className = 'share-modal active';
            modal.innerHTML = `
                <div class="share-modal-content profile-modal">
                    <span class="share-modal-close">&times;</span>
                    <h3>プロフィール設定</h3>
                    <div class="profile-avatar-container">
                        <div class="profile-avatar-wrapper" id="avatar-upload">
                            <div class="avatar-overlay">
                                <i class="fas fa-camera"></i>
                                <span>変更</span>
                            </div>
                        </div>
                        <input type="file" id="avatar-file" accept="image/*" style="display: none;">
                    </div>
                    <div class="form-group">
                        <label for="hunter-name" class="form-label">ハンター名:</label>
                        <input type="text" id="hunter-name" class="form-control" value="${profileData.hunterName || ''}">
                    </div>
                    <div class="form-row">
                        <div class="form-group half">
                            <label for="hunter-rank" class="form-label">ハンターランク:</label>
                            <input type="number" id="hunter-rank" class="form-control" min="1" value="${profileData.hunterRank || 1}">
                        </div>
                        <div class="form-group half">
                            <label for="platform" class="form-label">プラットフォーム:</label>
                            <select id="platform" class="form-control">
                                <option value="PS5" ${profileData.platform === 'PS5' ? 'selected' : ''}>PS5</option>
                                <option value="PC" ${profileData.platform === 'PC' ? 'selected' : ''}>PC</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="player-id" class="form-label">プレイヤーID:</label>
                        <input type="text" id="player-id" class="form-control" value="${profileData.playerId || ''}">
                    </div>
                    <div class="form-row">
                        <div class="form-group half">
                            <label for="main-weapon" class="form-label">メイン武器:</label>
                            <select id="main-weapon" class="form-control">
                                <option value="">選択してください</option>
                                <option value="大剣" ${profileData.mainWeapon === '大剣' ? 'selected' : ''}>大剣</option>
                                <option value="太刀" ${profileData.mainWeapon === '太刀' ? 'selected' : ''}>太刀</option>
                                <option value="片手剣" ${profileData.mainWeapon === '片手剣' ? 'selected' : ''}>片手剣</option>
                                <option value="双剣" ${profileData.mainWeapon === '双剣' ? 'selected' : ''}>双剣</option>
                                <option value="ハンマー" ${profileData.mainWeapon === 'ハンマー' ? 'selected' : ''}>ハンマー</option>
                                <option value="狩猟笛" ${profileData.mainWeapon === '狩猟笛' ? 'selected' : ''}>狩猟笛</option>
                                <option value="ランス" ${profileData.mainWeapon === 'ランス' ? 'selected' : ''}>ランス</option>
                                <option value="ガンランス" ${profileData.mainWeapon === 'ガンランス' ? 'selected' : ''}>ガンランス</option>
                                <option value="スラッシュアックス" ${profileData.mainWeapon === 'スラッシュアックス' ? 'selected' : ''}>スラッシュアックス</option>
                                <option value="チャージアックス" ${profileData.mainWeapon === 'チャージアックス' ? 'selected' : ''}>チャージアックス</option>
                                <option value="操虫棍" ${profileData.mainWeapon === '操虫棍' ? 'selected' : ''}>操虫棍</option>
                                <option value="ライトボウガン" ${profileData.mainWeapon === 'ライトボウガン' ? 'selected' : ''}>ライトボウガン</option>
                                <option value="ヘヴィボウガン" ${profileData.mainWeapon === 'ヘヴィボウガン' ? 'selected' : ''}>ヘヴィボウガン</option>
                                <option value="弓" ${profileData.mainWeapon === '弓' ? 'selected' : ''}>弓</option>
                            </select>
                        </div>
                        <div class="form-group half">
                            <label for="play-time" class="form-label">プレイ時間(時間):</label>
                            <input type="number" id="play-time" class="form-control" min="0" value="${profileData.playTime || 0}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="bio" class="form-label">自己紹介:</label>
                        <textarea id="bio" class="form-control" rows="3">${profileData.bio || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <button id="save-profile" class="btn btn-primary btn-block">プロフィールを保存</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // アバター変更のイベントリスナー
            const avatarUpload = document.getElementById('avatar-upload');
            const avatarFile = document.getElementById('avatar-file');

            avatarUpload.addEventListener('click', () => {
                avatarFile.click();
            });

            avatarFile.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    const reader = new FileReader();

                    reader.onload = (e) => {
                        document.getElementById('profile-avatar').src = e.target.result;
                    };

                    reader.readAsDataURL(file);
                }
            });

            // 閉じるボタンの処理
            const closeBtn = modal.querySelector('.share-modal-close');
            closeBtn.onclick = () => {
                modal.classList.remove('active');
                setTimeout(() => modal.remove(), 300);
            };

            // 保存ボタンの処理
            const saveBtn = document.getElementById('save-profile');
            saveBtn.onclick = () => {
                // プロフィールデータを更新
                profileData.hunterName = document.getElementById('hunter-name').value.trim();
                profileData.hunterRank = parseInt(document.getElementById('hunter-rank').value) || 1;
                profileData.platform = document.getElementById('platform').value;
                profileData.playerId = document.getElementById('player-id').value.trim();
                profileData.mainWeapon = document.getElementById('main-weapon').value;
                profileData.playTime = parseInt(document.getElementById('play-time').value) || 0;
                profileData.bio = document.getElementById('bio').value.trim();

                // アバター画像を保存
                const avatar = document.getElementById('profile-avatar');
                if (avatar.src) {
                    profileData.avatarData = avatar.src;
                }

                // プロフィールを保存
                saveProfile();

                // モーダルを閉じる
                modal.classList.remove('active');
                setTimeout(() => modal.remove(), 300);

                // ヘッダープロフィール表示を更新
                updateHeaderProfile();
            };
        }

        // 共有URLの処理（プリセット関連）
        function processPresetShareLink(shareData) {
            if (shareData.type !== 'preset') return;

            const preset = shareData.data;

            // 共有プリセットの詳細を表示するモーダルを作成
            const modal = document.createElement('div');
            modal.className = 'share-modal active';

            // スキル一覧を構築
            let skillsList = '';
            if (preset.skills && preset.skills.length > 0) {
                skillsList = preset.skills.map(skill =>
                    `<span class="tag-badge">${skill.name} Lv${skill.level}</span>`
                ).join(' ');
            } else {
                skillsList = '<span class="text-muted">スキル情報なし</span>';
            }

            modal.innerHTML = `
                <div class="share-modal-content">
                    <span class="share-modal-close">&times;</span>
                    <h3>共有された装備プリセット</h3>
                    <div class="share-details">
                        <p><strong>プリセット名:</strong> ${preset.name}</p>
                        <div class="preset-equipment">
                            <div><strong>武器:</strong> ${preset.equipment.weapon ? preset.equipment.weapon.name : '未設定'}</div>
                            <div><strong>頭:</strong> ${preset.equipment.head ? preset.equipment.head.name : '未設定'}</div>
                            <div><strong>胴:</strong> ${preset.equipment.body ? preset.equipment.body.name : '未設定'}</div>
                            <div><strong>腕:</strong> ${preset.equipment.arms ? preset.equipment.arms.name : '未設定'}</div>
                            <div><strong>腰:</strong> ${preset.equipment.waist ? preset.equipment.waist.name : '未設定'}</div>
                            <div><strong>脚:</strong> ${preset.equipment.legs ? preset.equipment.legs.name : '未設定'}</div>
                            <div><strong>護石:</strong> ${preset.equipment.charm ? preset.equipment.charm.name : '未設定'}</div>
                        </div>
                        <div class="preset-skills">
                            <div><strong>発動スキル:</strong></div>
                            <div class="skills-container">
                                ${skillsList}
                            </div>
                        </div>
                        ${preset.notes ? `<div class="preset-notes"><strong>メモ:</strong> ${preset.notes}</div>` : ''}
                    </div>
                    <div class="share-options">
                        <button class="btn btn-primary btn-block" id="importSharedPreset">
                            このプリセットをインポート
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // 閉じるボタンの処理
            const closeBtn = modal.querySelector('.share-modal-close');
            closeBtn.onclick = () => {
                modal.classList.remove('active');
                setTimeout(() => modal.remove(), 300);

                // URLからパラメータを削除
                window.history.replaceState({}, document.title, window.location.pathname);
            };

            // インポートボタンの処理
            const importBtn = document.getElementById('importSharedPreset');
            importBtn.onclick = () => {
                // 既存のプリセットと重複がないか確認
                const isDuplicate = equipmentPresets.some(p =>
                    p.name === preset.name &&
                    p.equipment.weapon && preset.equipment.weapon &&
                    p.equipment.weapon.name === preset.equipment.weapon.name
                );

                if (isDuplicate) {
                    if (!confirm('同じ名前のプリセットが既に存在します。それでもインポートしますか？')) {
                        return;
                    }
                }

                // プリセットをインポート
                const newPreset = {
                    ...preset,
                    id: Date.now().toString(), // 新しいIDを割り当て
                    created: new Date().toISOString(),
                    lastUsed: new Date().toISOString()
                };

                equipmentPresets.push(newPreset);
                savePresets();

                // プリセットリストを更新
                if (document.getElementById('presets-container')) {
                    updatePresetList('presets-container');
                }

                // モーダルを閉じる
                modal.classList.remove('active');
                setTimeout(() => modal.remove(), 300);

                // URLからパラメータを削除
                window.history.replaceState({}, document.title, window.location.pathname);

                // 成功メッセージを表示
                const message = document.createElement('div');
                message.className = 'toast-message';
                message.innerHTML = `<i class="fas fa-check-circle"></i> プリセット「${newPreset.name}」をインポートしました`;
                document.body.appendChild(message);

                setTimeout(() => {
                    message.classList.add('toast-show');
                    setTimeout(() => {
                        message.classList.remove('toast-show');
                        setTimeout(() => message.remove(), 300);
                    }, 3000);
                }, 10);
            };
        }


        // 装備データをロード
        async function loadEquipmentData() {
            try {
              // 武器データの読み込み
              const weaponResponse = await fetch('./weapon_data.json');
              const weaponData = await weaponResponse.json();

              // ボウガンデータの読み込み
              const bowgunResponse = await fetch('./weapon_bowgun_data.json');
              const bowgunData = await bowgunResponse.json();

              // 防具データの読み込み
              const armorResponse = await fetch('./armordata.json');
              const armorData = await armorResponse.json();

              // 護石データの読み込み
              const charmResponse = await fetch('./charm.json');
              const charmData = await charmResponse.json();

              // 装飾品データの読み込み
              const decoWResponse = await fetch('./w_deco.json');
              const decoWData = await decoWResponse.json();

              const decoAResponse = await fetch('./a_deco.json');
              const decoAData = await decoAResponse.json();

              // スキルデータの読み込み
              const weaponSkillResponse = await fetch('./W_skill.json');
              const weaponSkillData = await weaponSkillResponse.json();

              const armorSkillResponse = await fetch('./A_skill.json');
              const armorSkillData = await armorSkillResponse.json();

              // グループスキルとシリーズスキルの読み込み
              const groupSkillResponse = await fetch('./group_skill.json');
              const groupSkillData = await groupSkillResponse.json();

              const groupReqResponse = await fetch('./group_req.json');
              const groupReqData = await groupReqResponse.json();

              const seriesSkillResponse = await fetch('./series_skill.json');
              const seriesSkillData = await seriesSkillResponse.json();

              const seriesReqResponse = await fetch('./series_req.json');
              const seriesReqData = await seriesReqResponse.json();

              // データを保存
              window.equipmentDB = {
                  weapons: {
                      normal: weaponData,
                      bowgun: bowgunData
                  },
                  armors: armorData,
                  charms: charmData,
                  decorations: {
                      weapon: decoWData,
                      armor: decoAData
                  },
                  skills: {
                      weapon: weaponSkillData,
                      armor: armorSkillData,
                      group: groupSkillData,
                      series: seriesSkillData
                  },
                  requirements: {
                      group: groupReqData,
                      series: seriesReqData
                  }
              };

              console.log('装備データを読み込みました');
              return true;
          } catch (error) {
              console.error('装備データの読み込みに失敗しました:', error);
              return false;
          }
        }
        function getSkillNameById(id) {
            const skills = window.equipmentDB.skills;

            // 配列形式  [{id:1,name:'攻撃'}, …]
            if (Array.isArray(skills)) {
                const hit = skills.find(s => s.id == id);
                return hit ? hit.name : `ID${id}`;
            }

            // 辞書形式  { "1": {name:"攻撃",…}, "2":{…} }
            if (skills && typeof skills === 'object') {
                return skills[id] ? skills[id].name : `ID${id}`;
            }
            return `ID${id}`;        // 万一どちらでもない場合
        }

        // 装備選択ダイアログでJSONデータを利用
        function _show_equipment_selector(data_list, equip_type) {
            // 既存の実装に加えて、window.equipmentDBからデータを取得する場合の処理を追加
            if (!data_list || data_list.length === 0) {
                if (window.equipmentDB) {
                    if (equip_type === "weapon") {
                        // 通常武器とボウガンの両方を結合
                        data_list = [...window.equipmentDB.weapons.normal, ...window.equipmentDB.weapons.bowgun];
                    } else if (equip_type === "charm") {
                        data_list = window.equipmentDB.charms;
                    } else {
                        // 部位に応じた防具データのフィルタリング
                        const part_map = {"head": "頭", "body": "胴", "arms": "腕", "waist": "腰", "legs": "脚"};
                        data_list = window.equipmentDB.armors.filter(a => a["bui"] === part_map[equip_type]);
                    }
                }
            }
            // グループスキルとシリーズスキルの要件を確認する関数
            function checkSetRequirements(head, body, arm, waist, leg) {
                if (!window.equipmentDB || !window.equipmentDB.requirements) {
                    return { success: false, groupSkills: [], seriesSkills: [] };
                }

                // グループIDとシリーズIDを抽出
                const parts = { "頭": head, "胴": body, "腕": arm, "腰": waist, "脚": leg };

                // 各部位のグループIDとシリーズIDを集計
                const groupCounts = {};
                const seriesCounts = {};

                for (const [partName, armor] of Object.entries(parts)) {
                    if (armor && armor.groupId) {
                        const gid = armor.groupId;
                        if (!groupCounts[gid]) {
                            groupCounts[gid] = new Set();
                        }
                        groupCounts[gid].add(partName);
                    }

                    if (armor && armor.seriesId) {
                        const sid = armor.seriesId;
                        if (!seriesCounts[sid]) {
                            seriesCounts[sid] = new Set();
                        }
                        seriesCounts[sid].add(partName);
                    }
                }

                // グループスキルの発動スキルを確認
                const activatedGroupSkills = new Set();
                for (const [gid, partsSet] of Object.entries(groupCounts)) {
                    const groupReqs = window.equipmentDB.requirements.group.find(g => g.id === parseInt(gid));
                    if (groupReqs) {
                        for (const req of groupReqs.req) {
                            if (partsSet.size >= req.parts) { // 必要部位数を満たす
                                req.skillIds.forEach(id => activatedGroupSkills.add(id));
                            }
                        }
                    }
                }

                // シリーズスキルの発動スキルを確認
                const activatedSeriesSkills = new Set();
                for (const [sid, partsSet] of Object.entries(seriesCounts)) {
                    const seriesReqs = window.equipmentDB.requirements.series.find(s => s.id === parseInt(sid));
                    if (seriesReqs) {
                        for (const req of seriesReqs.req) {
                            if (partsSet.size >= req.parts) { // 必要部位数を満たす
                                req.skillIds.forEach(id => activatedSeriesSkills.add(id));
                            }
                        }
                    }
                }

                return {
                    success: true,
                    groupSkills: Array.from(activatedGroupSkills),
                    seriesSkills: Array.from(activatedSeriesSkills)
                };
            }
        }
        // スキル名とレベル情報を取得する関数
        function getSkillInfo(skillId) {
            if (!window.equipmentDB || !window.equipmentDB.skills) {
                return { name: `不明なスキル(${skillId})`, maxLevel: 1 };
            }

            // 全スキルから検索
            const allSkills = [
                ...window.equipmentDB.skills.weapon,
                ...window.equipmentDB.skills.armor,
                ...window.equipmentDB.skills.group,
                ...window.equipmentDB.skills.series
            ];

            const skill = allSkills.find(s => s.id === skillId);

            if (skill) {
                return {
                    name: skill.name,
                    maxLevel: skill.max || 1,
                    description: skill.text || "",
                    levels: skill.lv || {}
                };
            }

            return { name: `スキルID: ${skillId}`, maxLevel: 1 };
        }
        // 共有URLの処理機能拡張
        function processShareLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const shareParam = urlParams.get('share');

            if (shareParam) {
                try {
                    // Base64デコード（非ASCII文字対応）
                    const shareData = JSON.parse(b64_to_utf8(shareParam));

                    // 共有タイプに応じた処理
                    if (shareData.type === 'record') {
                        // 既存の記録共有処理
                        processRecordShareLink(shareData);
                    } else if (shareData.type === 'preset') {
                        // 新規追加: プリセット共有処理
                        processPresetShareLink(shareData);
                    }
                } catch (e) {
                    console.error('共有データの解析に失敗しました:', e);
                }
            }
        }

        // 記録追加時に装備設定を使用できるように拡張
        function enhanceRecordForm() {
            const recordForm = document.getElementById('record-form');
            if (!recordForm) return;

            // プリセット選択用のフィールドを追加
            const presetField = document.createElement('div');
            presetField.className = 'form-group';
            presetField.innerHTML = `
                <label for="preset-select" class="form-label">装備プリセット:</label>
                <div class="preset-select-container">
                    <select id="preset-select" class="form-control">
                        <option value="">プリセットを選択</option>
                        <!-- プリセットリストはJavaScriptで動的に生成 -->
                    </select>
                    <button type="button" id="preset-details-btn" class="btn btn-secondary preset-btn" disabled>
                        <i class="fas fa-info-circle"></i>
                    </button>
                    <button type="button" id="preset-manage-btn" class="btn btn-secondary preset-btn">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            `;

            // フォームの先頭に挿入
            const firstChild = recordForm.firstChild;
            recordForm.insertBefore(presetField, firstChild);

            // プリセットセレクトボックスを更新
            updatePresetSelect();

            // プリセット詳細ボタンのイベントリスナー
            const detailsBtn = document.getElementById('preset-details-btn');
            detailsBtn.addEventListener('click', () => {
                const presetId = document.getElementById('preset-select').value;
                if (!presetId) return;

                const preset = getPresetById(presetId);
                if (!preset) return;

                // プリセット詳細モーダルを表示
                const modal = document.createElement('div');
                modal.className = 'share-modal active';

                // スキル一覧を構築
                let skillsList = '';
                if (preset.skills && preset.skills.length > 0) {
                    skillsList = preset.skills.map(skill =>
                        `<span class="tag-badge">${skill.name} Lv${skill.level}</span>`
                    ).join(' ');
                } else {
                    skillsList = '<span class="text-muted">スキル情報なし</span>';
                }

                modal.innerHTML = `
                    <div class="share-modal-content">
                        <span class="share-modal-close">&times;</span>
                        <h3>プリセット詳細: ${preset.name}</h3>
                        <div class="preset-details">
                            <div class="preset-equipment">
                                <h4>装備情報</h4>
                                <div><strong>武器:</strong> ${preset.equipment.weapon ? preset.equipment.weapon.name : '未設定'}</div>
                                <div><strong>頭:</strong> ${preset.equipment.head ? preset.equipment.head.name : '未設定'}</div>
                                <div><strong>胴:</strong> ${preset.equipment.body ? preset.equipment.body.name : '未設定'}</div>
                                <div><strong>腕:</strong> ${preset.equipment.arms ? preset.equipment.arms.name : '未設定'}</div>
                                <div><strong>腰:</strong> ${preset.equipment.waist ? preset.equipment.waist.name : '未設定'}</div>
                                <div><strong>脚:</strong> ${preset.equipment.legs ? preset.equipment.legs.name : '未設定'}</div>
                                <div><strong>護石:</strong> ${preset.equipment.charm ? preset.equipment.charm.name : '未設定'}</div>
                            </div>
                            <div class="preset-skills">
                                <h4>発動スキル</h4>
                                <div class="skills-container">
                                    ${skillsList}
                                </div>
                            </div>
                            ${preset.notes ? `<div class="preset-notes"><h4>メモ</h4><p>${preset.notes}</p></div>` : ''}
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // 閉じるボタンの処理
                const closeBtn = modal.querySelector('.share-modal-close');
                closeBtn.onclick = () => {
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 300);
                };
            });

            // プリセット管理ボタンのイベントリスナー
            const manageBtn = document.getElementById('preset-manage-btn');
            manageBtn.addEventListener('click', () => {
                showPresetManagementModal();
            });

            // プリセット選択時のイベントリスナー
            const presetSelect = document.getElementById('preset-select');
            presetSelect.addEventListener('change', () => {
                const presetId = presetSelect.value;
                detailsBtn.disabled = !presetId;

                if (presetId) {
                    // 選択されたプリセットを適用
                    applyPresetToForm(presetId);
                }
            });

            // フォーム送信時のフック
            const originalSubmitEvent = recordForm.onsubmit;
            recordForm.onsubmit = function(e) {
                // プリセットIDを記録に関連付け
                const presetId = document.getElementById('preset-select').value;

                // オリジナルのイベントハンドラを呼び出す
                if (originalSubmitEvent) {
                    const result = originalSubmitEvent.call(this, e);

                    // プリセットの最終使用日時を更新
                    if (presetId) {
                        const preset = getPresetById(presetId);
                        if (preset) {
                            preset.lastUsed = new Date().toISOString();
                            updatePreset(presetId, preset);
                        }
                    }

                    return result;
                }
            };
        }

        // プリセットセレクトボックスを更新
        function updatePresetSelect() {
            const presetSelect = document.getElementById('preset-select');
            if (!presetSelect) return;

            // 既存のオプションをクリア（最初の「選択してください」以外）
            while (presetSelect.options.length > 1) {
                presetSelect.remove(1);
            }

            // プリセットを最終使用日時の降順でソート
            const sortedPresets = [...equipmentPresets].sort((a, b) =>
                new Date(b.lastUsed || b.created) - new Date(a.lastUsed || a.created)
            );

            // プリセットオプションを追加
            sortedPresets.forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.id;
                option.textContent = preset.name;
                presetSelect.appendChild(option);
            });
        }

        // プリセットをフォームに適用
        function applyPresetToForm(presetId) {
            const preset = getPresetById(presetId);
            if (!preset) return;

            // 武器種を選択
            if (preset.equipment.weapon && document.getElementById('weapon-select')) {
                document.getElementById('weapon-select').value = preset.equipment.weapon.type || '';
            }

            // メモ欄にプリセット情報を追記
            if (document.getElementById('notes')) {
                const notesElem = document.getElementById('notes');
                const currentNotes = notesElem.value.trim();
                const presetInfo = `プリセット: ${preset.name}`;

                if (currentNotes) {
                    if (!currentNotes.includes(presetInfo)) {
                        notesElem.value = `${currentNotes} / ${presetInfo}`;
                    }
                } else {
                    notesElem.value = presetInfo;
                }
            }

            // 装備スキル情報をタグとして追加
            if (document.getElementById('tags') && preset.skills && preset.skills.length > 0) {
                const tagsElem = document.getElementById('tags');
                const currentTags = tagsElem.value.trim();
                const skillTags = preset.skills.map(skill => `${skill.name}${skill.level}`).join(',');

                if (currentTags) {
                    const tagArray = currentTags.split(',').map(tag => tag.trim());
                    const newTags = preset.skills
                        .map(skill => `${skill.name}${skill.level}`)
                        .filter(tag => !tagArray.includes(tag));

                    if (newTags.length > 0) {
                        tagsElem.value = `${currentTags},${newTags.join(',')}`;
                    }
                } else {
                    tagsElem.value = skillTags;
                }
            }

            // 最終使用日時を更新
            preset.lastUsed = new Date().toISOString();
            updatePreset(presetId, preset);
        }

        // プリセット管理モーダルを表示
        function showPresetManagementModal() {
            // モーダルを作成・表示
            const modal = document.createElement('div');
            modal.className = 'share-modal active';
            modal.innerHTML = `
                <div class="share-modal-content preset-management-modal">
                    <span class="share-modal-close">&times;</span>
                    <h3>装備プリセット管理</h3>
                    <div class="preset-tabs">
                        <button class="preset-tab active" data-tab="presets-list">プリセット一覧</button>
                        <button class="preset-tab" data-tab="add-preset">新規作成</button>
                    </div>
                    <div class="preset-tab-content active" id="presets-list">
                        <div id="presets-container" class="presets-container">
                            <!-- プリセットリストはJavaScriptで動的に生成 -->
                        </div>
                    </div>
                    <div class="preset-tab-content" id="add-preset">
                        <div class="form-group">
                            <label for="new-preset-name" class="form-label">プリセット名:</label>
                            <input type="text" id="new-preset-name" class="form-control" placeholder="新しいプリセット名">
                        </div>
                        <div class="form-group">
                            <label class="form-label">現在の装備をインポート:</label>
                            <button id="import-from-simulation" class="btn btn-secondary btn-block">シミュレーションから装備をインポート</button>
                        </div>
                        <div class="form-group">
                            <label for="new-preset-notes" class="form-label">メモ:</label>
                            <textarea id="new-preset-notes" class="form-control" rows="3" placeholder="メモ（オプション）"></textarea>
                        </div>
                        <div class="form-group">
                            <button id="create-new-preset" class="btn btn-primary btn-block">プリセットを作成</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // タブ切り替え
            const tabs = modal.querySelectorAll('.preset-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // アクティブなタブを解除
                    tabs.forEach(t => t.classList.remove('active'));
                    modal.querySelectorAll('.preset-tab-content').forEach(content => {
                        content.classList.remove('active');
                    });

                    // 選択されたタブをアクティブに
                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });

            // プリセットリストを更新
            updatePresetList('presets-container');

            // シミュレーションからインポートボタンの処理
            const importBtn = document.getElementById('import-from-simulation');
            importBtn.addEventListener('click', () => {
                // シミュレーションタブの装備データを取得
                const simulationData = getSimulationEquipmentData();

                if (simulationData && simulationData.equipment && Object.values(simulationData.equipment).some(item => item)) {
                    // プリセット名に装備名を反映
                    const presetNameInput = document.getElementById('new-preset-name');
                    if (!presetNameInput.value) {
                        const equipName = simulationData.equipment.weapon ? simulationData.equipment.weapon.name : '装備セット';
                        presetNameInput.value = equipName;
                    }

                    // 適用メッセージを表示
                    const message = document.createElement('div');
                    message.className = 'modal-message success';
                    message.innerHTML = `<i class="fas fa-check-circle"></i> シミュレーションの装備をインポートしました`;

                    const tabContent = document.getElementById('add-preset');
                    tabContent.appendChild(message);

                    setTimeout(() => {
                        message.classList.add('show');
                        setTimeout(() => {
                            message.classList.remove('show');
                            setTimeout(() => message.remove(), 300);
                        }, 2000);
                    }, 10);
                } else {
                    // エラーメッセージ
                    alert('シミュレーションからインポートできる装備データがありません。シミュレーションタブで装備を設定してください。');
                }
            });

            // 新規プリセット作成ボタンの処理
            const createBtn = document.getElementById('create-new-preset');
            createBtn.addEventListener('click', () => {
                const name = document.getElementById('new-preset-name').value.trim();
                const notes = document.getElementById('new-preset-notes').value.trim();

                if (!name) {
                    alert('プリセット名を入力してください');
                    return;
                }

                // シミュレーションから装備データを取得
                const simulationData = getSimulationEquipmentData();

                if (!simulationData || !simulationData.equipment || !Object.values(simulationData.equipment).some(item => item)) {
                    alert('装備データがありません。シミュレーションからインポートするか、先に装備を設定してください。');
                    return;
                }

                // プリセットを作成
                const newPreset = {
                    id: Date.now().toString(),
                    name: name,
                    created: new Date().toISOString(),
                    lastUsed: new Date().toISOString(),
                    equipment: simulationData.equipment,
                    skills: simulationData.skills || [],
                    notes: notes
                };

                // プリセットを保存
                equipmentPresets.push(newPreset);
                savePresets();

                // プリセットリストを更新
                updatePresetList('presets-container');

                // プリセットセレクトボックスを更新
                updatePresetSelect();

                // フォームをリセット
                document.getElementById('new-preset-name').value = '';
                document.getElementById('new-preset-notes').value = '';

                // 成功メッセージを表示
                const message = document.createElement('div');
                message.className = 'modal-message success';
                message.innerHTML = `<i class="fas fa-check-circle"></i> プリセット「${newPreset.name}」を作成しました`;

                const tabContent = document.getElementById('add-preset');
                tabContent.appendChild(message);

                setTimeout(() => {
                    message.classList.add('show');
                    setTimeout(() => {
                        message.classList.remove('show');
                        setTimeout(() => message.remove(), 300);

                        // タブをプリセット一覧に切り替え
                        tabs[0].click();
                    }, 2000);
                }, 10);
            });

            // 閉じるボタンの処理
            const closeBtn = modal.querySelector('.share-modal-close');
            closeBtn.onclick = () => {
                modal.classList.remove('active');
                setTimeout(() => modal.remove(), 300);

                // プリセットセレクトボックスを更新
                updatePresetSelect();
            };
        }

        // シミュレーションから装備データを取得
        function getSimulationEquipmentData() {
            // シミュレーションタブを探す
            let simTab = null;
            for (const notebook of document.querySelectorAll('.TNotebook')) {
                for (let i = 0; i < notebook.tabs.length; i++) {
                    if (notebook.tab(notebook.tabs[i], 'text') === 'シミュレーション') {
                        simTab = notebook.nametowidget(notebook.tabs[i]);
                        break;
                    }
                }
                if (simTab) break;
            }

            if (!simTab) {
                // シミュレーションタブが見つからない場合、別の方法で探す
                for (const label of document.querySelectorAll('.ttk-tab')) {
                    if (label.textContent === 'シミュレーション') {
                        // このタブを含む親要素を探す
                        let parent = label.parentElement;
                        while (parent && !parent.classList.contains('ttk-notebook')) {
                            parent = parent.parentElement;
                        }

                        if (parent) {
                            // 対応するtab-content要素を探す
                            const index = Array.from(parent.querySelectorAll('.ttk-tab')).indexOf(label);
                            const contents = parent.querySelectorAll('.tab-content');
                            if (index >= 0 && index < contents.length) {
                                simTab = contents[index];
                            }
                        }
                        break;
                    }
                }
            }

            if (!simTab) {
                console.error('シミュレーションタブが見つかりません');
                return null;
            }

            // 装備データを探す
            const equipmentData = {
                equipment: {
                    weapon: null,
                    head: null,
                    body: null,
                    arms: null,
                    waist: null,
                    legs: null,
                    charm: null
                },
                skills: []
            };

            // 装備フレームを探す
            let equipFrame = null;
            for (const frame of simTab.querySelectorAll('.ttk-labelframe')) {
                if (frame.getAttribute('text') === '装備選択') {
                    equipFrame = frame;
                    break;
                }
            }

            if (!equipFrame) {
                console.error('装備フレームが見つかりません');
                return null;
            }

            // 各装備行を分析
            const equipRows = equipFrame.querySelectorAll('.ttk-frame');
            for (const row of equipRows) {
                // 装備タイプを特定
                let equipType = null;
                for (const label of row.querySelectorAll('.ttk-label')) {
                    const text = label.textContent.trim();
                    if (text === '武器:') equipType = 'weapon';
                    else if (text === '頭:') equipType = 'head';
                    else if (text === '胴:') equipType = 'body';
                    else if (text === '腕:') equipType = 'arms';
                    else if (text === '腰:') equipType = 'waist';
                    else if (text === '脚:') equipType = 'legs';
                    else if (text === '護石:') equipType = 'charm';

                    if (equipType) break;
                }

                if (!equipType) continue;

                // 装備名を取得
                const entry = row.querySelector('.ttk-entry');
                if (entry && entry.value && entry.value !== '未選択') {
                    equipmentData.equipment[equipType] = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 5), // 一時的なID
                        name: entry.value
                    };

                    // 武器の場合は武器種も保存
                    if (equipType === 'weapon') {
                        const weaponTypeElem = document.getElementById('weapon-select');
                        if (weaponTypeElem) {
                            equipmentData.equipment.weapon.type = weaponTypeElem.value;
                        }
                    }
                }
            }

            // スキルフレームを探す
            let skillFrame = null;
            for (const frame of simTab.querySelectorAll('.ttk-labelframe')) {
                if (frame.getAttribute('text') === '装備スキル') {
                    skillFrame = frame;
                    break;
                }
            }

            if (skillFrame) {
                // スキル一覧を取得
                const skillTree = skillFrame.querySelector('.ttk-treeview');
                if (skillTree) {
                    const skillItems = skillTree.querySelectorAll('item');
                    for (const item of skillItems) {
                        const values = skillTree.item(item, 'values');
                        if (values && values.length >= 2) {
                            equipmentData.skills.push({
                                name: values[0],
                                level: parseInt(values[1]) || 1
                            });
                        }
                    }
                }
            }

            return equipmentData;
        }

        // ================================
        // 3. JavaScript 側の初期化と挙動
        // ================================
        async function initSimulationUI() {

            /* ★ 1) 装備データがまだ無ければここでロード ★ */
            if (!window.equipmentDB || !window.equipmentDB.weapons) {
                const ok = await loadEquipmentData();    // ← 非同期で JSON 群を読む
                if (!ok) {                               // 失敗時は処理中断
                    alert('装備データの読み込みに失敗しました');
                return;
                }
            }
            
          const partMap = {
            weapon: [...window.equipmentDB.weapons.normal, ...window.equipmentDB.weapons.bowgun],
            head: window.equipmentDB.armors.filter(a=>a.bui==='頭'),
            body: window.equipmentDB.armors.filter(a=>a.bui==='胴'),
            arms: window.equipmentDB.armors.filter(a=>a.bui==='腕'),
            waist: window.equipmentDB.armors.filter(a=>a.bui==='腰'),
            legs: window.equipmentDB.armors.filter(a=>a.bui==='脚'),
            charm: window.equipmentDB.charms
          };

          // 装備と装飾品セレクトを作る
          Object.keys(partMap).forEach(part => {
            const sel = document.getElementById(`sim-${part}`);
            sel.innerHTML = `<option value="">選択なし</option>`
              + partMap[part]
                  .map(e=>`<option value="${e.id}">${e.name}</option>`)
                  .join('');
            // 装備が変わったらスロット数に応じた装飾品セレクトを生成
            sel.addEventListener('change', () => {
              // 護石には装飾品スロットが無いので早期リターン
            if (part === 'charm') return;

            const equip = partMap[part].find(e => e.id == sel.value);
            const decoContainer = document.getElementById(`deco-slots-${part}`);
            if (!decoContainer) return;    // 念のため
            decoContainer.innerHTML = '';
              if (!equip || !equip.slots) return;
              // 各スロット分、セレクトを追加
              equip.slots.forEach((size, idx) => {
                const decSel = document.createElement('select');
                decSel.className = 'form-control';
                const decoList = part === 'weapon'
                    ? window.equipmentDB.decorations.weapon   // 武器用のみ
                    : window.equipmentDB.decorations.armor;   // 防具用のみ
                decSel.innerHTML = `<option value="">装飾品なし</option>` +
                    decoList
                      .filter(d=>d.slot<=size)
                      .map(d=>`<option value="${d.id}">${d.name} (Lv${d.slot})</option>`)
                      .join('');
                decSel.addEventListener('change', () => {/* 変更後に結果再計算 */});
                const label = document.createElement('label');
                label.textContent = `装飾品(${size}スロット):`;
                decoContainer.append(label, decSel);
              });
            });
          });
        }

        // 実行ボタン
        document.getElementById('run-simulation').addEventListener('click', () => {
          const selected = {};
          const buiMap = { head:'頭', body:'胴', arms:'腕', waist:'腰', legs:'脚' };
          ['weapon','head','body','arms','waist','legs','charm'].forEach(part => {
            const id = document.getElementById(`sim-${part}`).value;
            if (!id) { selected[part] = null; return; }

            const pool =
              part === 'weapon'
                ? [...window.equipmentDB.weapons.normal, ...window.equipmentDB.weapons.bowgun]
                : part === 'charm'
                    ? window.equipmentDB.charms
                    : window.equipmentDB.armors.filter(a => a.bui === buiMap[part]);
            selected[part] = pool.find(e => e.id == id) || null;
          });
          // 装飾品は deco-slots-<part> 内の select から取得
            const decorations = {};
            ['weapon','head','body','arms','waist','legs']   // ← charm はスロットなし
                .forEach(part => {
                const container = document.getElementById(`deco-slots-${part}`);
                if (!container) { decorations[part] = []; return; }  // 念のため

                decorations[part] = Array.from(
                container.querySelectorAll('select')
                ).map(sel => {
                    const decoId = sel.value;
                    if (!decoId) return null;
                    return window.equipmentDB.decorations.weapon
                            .concat(window.equipmentDB.decorations.armor)
                            .find(d => d.id == decoId) || null;
                });
            });

          // スキル集計
          let skillTotal = {};
          Object.values(selected).forEach(equip=>{
            if (equip && equip.skills) {
              equip.skills.forEach(s=>{
                skillTotal[s.id] = (skillTotal[s.id]||0) + s.lv;
              });
            }
          });
          Object.values(decorations).flat().forEach(deco=>{
            if (deco && deco.skills) {
              deco.skills.forEach(s=>{
                skillTotal[s.id] = (skillTotal[s.id]||0) + s.lv;
              });
            }
          });

          // 結果表示
          const ul = document.getElementById('sim-skill-list');
          ul.innerHTML = '';
          Object.entries(skillTotal)
            .sort((a, b) => getSkillNameById(a[0]).localeCompare(getSkillNameById(b[0])))
            .forEach(([id,lv])=>{
                const name = getSkillNameById(id);
              ul.innerHTML += `<li>${name} Lv${lv}</li>`;
            });
        });

        // 初期化
        // 初期化（装備DB読込 → UI構築 の順）
        document.addEventListener('DOMContentLoaded', async () => {
            // 装備 JSON 群を読み込む
            const ok = await loadEquipmentData();
            if (!ok) {
                alert('装備データの読み込みに失敗しました');
            return;
            }
            // UI を組み立て
            initSimulationUI();
        });

        // 記録の共有拡張（装備データを含める）
        function shareRecord(recordId) {
            const record = recordsData.find(r => r.id === recordId);
            if (!record) return;

            // 現在の共有データを取得
            let shareData = {
                type: 'record',
                data: record
            };

            // 装備データがあれば追加
            if (record.equipmentPresetId) {
                const preset = getPresetById(record.equipmentPresetId);
                if (preset) {
                    shareData.equipment = preset;
                }
            }

            // モーダルを作成
            const modal = document.createElement('div');
            modal.className = 'share-modal';
            modal.innerHTML = `
                <div class="share-modal-content">
                    <span class="share-modal-close">&times;</span>
                    <h3>記録を共有</h3>
                    <div class="share-details">
                        <p><strong>モンスター:</strong> ${record.monster}</p>
                        <p><strong>武器種:</strong> ${record.weapon}</p>
                        <p><strong>タイム:</strong> ${record.timeString}</p>
                        <p><strong>日付:</strong> ${formatDate(record.date)}</p>
                        ${shareData.equipment ? `<p><strong>装備セット:</strong> ${shareData.equipment.name}</p>` : ''}
                    </div>
                    <div class="share-options">
                        <button class="btn btn-secondary share-btn" id="copyShareLink">
                            <i class="fas fa-link"></i> リンクをコピー
                          </button>
                          <button class="btn btn-secondary share-btn" id="generateQR">
                              <i class="fas fa-qrcode"></i> QRコードを生成
                          </button>
                          <button class="btn btn-secondary share-btn" id="shareTwitter">
                              <i class="fab fa-twitter"></i> Twitterで共有
                          </button>
                          ${navigator.share ? `
                          <button class="btn btn-secondary share-btn" id="nativeShare">
                              <i class="fas fa-share-alt"></i> ネイティブ共有
                          </button>` : ''}
                      </div>
                      <div id="qrCodeContainer" class="qr-code-container"></div>
                      <div id="shareStatus" class="share-status"></div>
                  </div>
              `;

              document.body.appendChild(modal);

              // モーダルを表示（DOMに追加された後に）
              setTimeout(() => {
                  modal.classList.add('active');

                  // ここでイベントリスナーを設定（DOM要素が確実に存在する）
                  const closeBtn = modal.querySelector('.share-modal-close');
                  closeBtn.onclick = () => {
                      modal.classList.remove('active');
                      setTimeout(() => modal.remove(), 300);
                  };

                  // 共有用のURLを作成
                  // Base64エンコード（非ASCII文字対応）
                  const shareString = utf8_to_b64(JSON.stringify(shareData));
                  const shareUrl = `${window.location.href.split('?')[0]}?share=${shareString}`;

                  // リンクコピーボタンの処理
                  const copyBtn = document.getElementById('copyShareLink');
                  copyBtn.onclick = () => {
                      navigator.clipboard.writeText(shareUrl).then(() => {
                          document.getElementById('shareStatus').textContent = 'リンクをコピーしました！';
                          setTimeout(() => {
                              document.getElementById('shareStatus').textContent = '';
                          }, 2000);
                      }).catch(err => {
                          console.error('クリップボードへのコピーに失敗しました:', err);
                          // フォールバック: テキストフィールドを作成してコピー
                          const textArea = document.createElement('textarea');
                          textArea.value = shareUrl;
                          document.body.appendChild(textArea);
                          textArea.select();
                          document.execCommand('copy');
                          document.body.removeChild(textArea);
                          document.getElementById('shareStatus').textContent = 'リンクをコピーしました！';
                          setTimeout(() => {
                              document.getElementById('shareStatus').textContent = '';
                          }, 2000);
                      });
                  };

                  // QRコード生成ボタンの処理
                  const qrBtn = document.getElementById('generateQR');
                  qrBtn.onclick = () => {
                      const qrContainer = document.getElementById('qrCodeContainer');
                      qrContainer.innerHTML = '';

                      try {
                          // QRコード生成
                          new QRCode(qrContainer, {
                              text: shareUrl,
                              width: 200,
                              height: 200,
                              colorDark: '#8a5319',
                              colorLight: '#ffffff',
                              correctLevel: QRCode.CorrectLevel.H
                          });

                          // 成功メッセージ
                          document.getElementById('shareStatus').textContent = 'QRコードを生成しました！';
                          setTimeout(() => {
                              document.getElementById('shareStatus').textContent = '';
                          }, 2000);
                      } catch (error) {
                          console.error('QRコード生成に失敗しました:', error);
                          document.getElementById('shareStatus').textContent = 'QRコード生成に失敗しました';
                      }
                  };

                  // Twitterで共有ボタンの処理
                  const twitterBtn = document.getElementById('shareTwitter');
                  twitterBtn.onclick = () => {
                      // スキル情報をテキスト化
                      let skillsText = '';
                      if (shareData.equipment && shareData.equipment.skills && shareData.equipment.skills.length > 0) {
                          const skillNames = shareData.equipment.skills.map(skill => `${skill.name}Lv${skill.level}`).join('/');
                          skillsText = ` 【スキル: ${skillNames}】`;
                      }

                      // ツイート本文
                      const text = `MHワイルズ タイムアタック: ${record.monster} / ${record.weapon} / ${record.timeString}${skillsText}`;

                      // Twitter共有URL
                      const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(shareUrl)}`;
                      window.open(twitterUrl, '_blank');
                  };

                  // ネイティブ共有APIの処理（モバイルデバイス向け）
                  const nativeShareBtn = document.getElementById('nativeShare');
                  if (nativeShareBtn && navigator.share) {
                      nativeShareBtn.onclick = async () => {
                          try {
                              // スキル情報をテキスト化
                              let skillsText = '';
                              if (shareData.equipment && shareData.equipment.skills && shareData.equipment.skills.length > 0) {
                                  const skillNames = shareData.equipment.skills.map(skill => `${skill.name}Lv${skill.level}`).join('/');
                                  skillsText = ` 【スキル: ${skillNames}】`;
                              }

                              // 共有テキスト
                              const text = `MHワイルズ タイムアタック: ${record.monster} / ${record.weapon} / ${record.timeString}${skillsText}`;

                              await navigator.share({
                                  title: 'モンハン タイムアタック記録',
                                  text: text,
                                  url: shareUrl
                              });

                              document.getElementById('shareStatus').textContent = '共有しました！';
                              setTimeout(() => {
                                  document.getElementById('shareStatus').textContent = '';
                              }, 2000);
                          } catch (error) {
                              console.error('共有に失敗しました:', error);
                              document.getElementById('shareStatus').textContent = '共有に失敗しました';
                          }
                      };
                  }
                });   // setTimeout の閉じ
            }          // shareRecord の閉じ


          // 共有された記録に装備データがある場合の処理
          function processRecordShareLink(shareData) {
              if (shareData.type !== 'record') return;

              const record = shareData.data;
              const equipmentData = shareData.equipment;

              // 共有された記録の詳細を表示するモーダルを作成
              const modal = document.createElement('div');
              modal.className = 'share-modal active';

              // 装備情報のHTML構築
              let equipmentHtml = '';
              if (equipmentData) {
                  // スキル一覧を構築
                  let skillsList = '';
                  if (equipmentData.skills && equipmentData.skills.length > 0) {
                      skillsList = equipmentData.skills.map(skill =>
                          `<span class="tag-badge">${skill.name} Lv${skill.level}</span>`
                      ).join(' ');
                  } else {
                      skillsList = '<span class="text-muted">スキル情報なし</span>';
                  }

                  equipmentHtml = `
                      <div class="shared-equipment">
                          <h4>装備情報: ${equipmentData.name}</h4>
                          <div class="equipment-details">
                              <div><strong>武器:</strong> ${equipmentData.equipment.weapon ? equipmentData.equipment.weapon.name : '未設定'}</div>
                              <div><strong>頭:</strong> ${equipmentData.equipment.head ? equipmentData.equipment.head.name : '未設定'}</div>
                              <div><strong>胴:</strong> ${equipmentData.equipment.body ? equipmentData.equipment.body.name : '未設定'}</div>
                              <div><strong>腕:</strong> ${equipmentData.equipment.arms ? equipmentData.equipment.arms.name : '未設定'}</div>
                              <div><strong>腰:</strong> ${equipmentData.equipment.waist ? equipmentData.equipment.waist.name : '未設定'}</div>
                              <div><strong>脚:</strong> ${equipmentData.equipment.legs ? equipmentData.equipment.legs.name : '未設定'}</div>
                              <div><strong>護石:</strong> ${equipmentData.equipment.charm ? equipmentData.equipment.charm.name : '未設定'}</div>
                          </div>
                          <div class="equipment-skills">
                              <div><strong>発動スキル:</strong></div>
                              <div class="skills-container">
                                  ${skillsList}
                              </div>
                          </div>
                          ${equipmentData.notes ? `<div class="equipment-notes"><strong>メモ:</strong> ${equipmentData.notes}</div>` : ''}
                      </div>
                  `;
              }

              modal.innerHTML = `
                  <div class="share-modal-content">
                      <span class="share-modal-close">&times;</span>
                      <h3>共有された記録</h3>
                      <div class="share-details">
                          <p><strong>モンスター:</strong> ${record.monster}</p>
                          <p><strong>武器種:</strong> ${record.weapon}</p>
                          <p><strong>クエストタイプ:</strong> ${record.questType || '通常'}</p>
                          <p><strong>ステージ:</strong> ${record.stage || '-'}</p>
                          <p><strong>タイム:</strong> ${record.timeString}</p>
                          <p><strong>日付:</strong> ${formatDate(record.date)}</p>
                          ${record.notes ? `<p><strong>メモ:</strong> ${record.notes}</p>` : ''}
                          ${record.tags && record.tags.length > 0 ?
                              `<p><strong>タグ:</strong> ${record.tags.map(tag =>
                                  `<span class="tag-badge">${tag}</span>`
                              ).join(' ')}</p>` : ''}
                      </div>
                      ${equipmentHtml}
                      <div class="share-options">
                          <button class="btn btn-primary btn-block" id="importSharedRecord">
                              この記録をインポート
                          </button>
                          ${equipmentData ? `
                          <button class="btn btn-secondary btn-block" id="importSharedEquipment">
                              装備プリセットもインポート
                          </button>` : ''}
                      </div>
                  </div>
              `;

              document.body.appendChild(modal);

              // 閉じるボタンの処理
              const closeBtn = modal.querySelector('.share-modal-close');
              closeBtn.onclick = () => {
                  modal.classList.remove('active');
                  setTimeout(() => modal.remove(), 300);

                  // URLからパラメータを削除
                  window.history.replaceState({}, document.title, window.location.pathname);
              };

              // インポートボタンの処理
              const importBtn = document.getElementById('importSharedRecord');
              importBtn.onclick = () => {
                  // 既存の記録に重複がないか確認
                  const isDuplicate = recordsData.some(r =>
                      r.monster === record.monster &&
                      r.weapon === record.weapon &&
                      r.timeString === record.timeString &&
                      r.date === record.date
                  );

                  if (isDuplicate) {
                      if (!confirm('同じ記録が既に存在します。それでもインポートしますか？')) {
                          return;
                      }
                  }

                  // 装備プリセットIDを割り当て
                  let equipmentPresetId = null;
                  if (equipmentData) {
                      // 既存のプリセットと重複がないか確認
                      const existingPreset = equipmentPresets.find(p =>
                          p.name === equipmentData.name &&
                          p.equipment.weapon && equipmentData.equipment.weapon &&
                          p.equipment.weapon.name === equipmentData.equipment.weapon.name
                      );

                      if (existingPreset) {
                          equipmentPresetId = existingPreset.id;
                      } else {
                          // 確認ダイアログを表示
                          if (confirm('共有された装備プリセットをインポートしますか？')) {
                              const newPreset = {
                                  ...equipmentData,
                                  id: Date.now().toString(), // 新しいIDを割り当て
                                  created: new Date().toISOString(),
                                  lastUsed: new Date().toISOString()
                              };

                              equipmentPresets.push(newPreset);
                              savePresets();

                              // プリセットリストを更新
                              if (document.getElementById('presets-container')) {
                                  updatePresetList('presets-container');
                              }

                              equipmentPresetId = newPreset.id;
                          }
                      }
                  }

                  // 記録を追加
                  const newRecord = {
                      ...record,
                      id: Date.now().toString(), // 新しいIDを割り当て
                      hasImage: false, // 共有された記録には画像がない
                      equipmentPresetId: equipmentPresetId // 装備プリセットIDを関連付け
                  };

                  recordsData.push(newRecord);

                  // データをソート（時間の早い順）
                  recordsData.sort((a, b) => a.timeValue - b.timeValue);

                  // データを保存
                  saveRecordsToStorage();

                  // フィルターセレクト更新
                  updateFilterSelects();

                  // テーブルを更新
                  renderRecordsTable();

                  // 統計を更新
                  updateStatistics();

                  // チェックリストを更新
                  updateChecklist();

                  // ランキングを更新
                  updateRankings();

                  // モーダルを閉じる
                  modal.classList.remove('active');
                  setTimeout(() => modal.remove(), 300);

                  // URLからパラメータを削除
                  window.history.replaceState({}, document.title, window.location.pathname);

                  alert('記録がインポートされました！');
              };

              // 装備プリセットインポートボタンの処理
              const importEquipBtn = document.getElementById('importSharedEquipment');
              if (importEquipBtn && equipmentData) {
                  importEquipBtn.onclick = () => {
                      // 既存のプリセットと重複がないか確認
                      const isDuplicate = equipmentPresets.some(p =>
                          p.name === equipmentData.name &&
                          p.equipment.weapon && equipmentData.equipment.weapon &&
                          p.equipment.weapon.name === equipmentData.equipment.weapon.name
                      );

                      if (isDuplicate) {
                          if (!confirm('同じ名前のプリセットが既に存在します。それでもインポートしますか？')) {
                              return;
                          }
                      }

                      // プリセットをインポート
                      const newPreset = {
                          ...equipmentData,
                          id: Date.now().toString(), // 新しいIDを割り当て
                          created: new Date().toISOString(),
                          lastUsed: new Date().toISOString()
                      };

                      equipmentPresets.push(newPreset);
                      savePresets();

                      // プリセットリストを更新
                      if (document.getElementById('presets-container')) {
                          updatePresetList('presets-container');
                      }

                      // 成功メッセージを表示
                      alert(`装備プリセット「${newPreset.name}」をインポートしました`);
                  };
              }
          }

          // 新しいタブを追加: プロフィールと装備プリセット
          function addProfileEquipmentTabs(nb) {
          // --- プロフィールタブ本体 ------------------------------
          const profileTab = document.createElement('div');
          profileTab.id = 'profile-tab';
          profileTab.className = 'tab-content';
          profileTab.innerHTML = `<div class="profile-header">
              <div class="profile-avatar-large">
              </div>
              <div class="profile-info">
                  <h2 id="profile-hunter-name">${profileData.hunterName || 'ハンター名未設定'}</h2>
                  <div class="profile-details">
                      <p><strong>ハンターランク:</strong> <span id="profile-hunter-rank">${profileData.hunterRank || 1}</span></p>
                      <p><strong>プラットフォーム:</strong> <span id="profile-platform">${profileData.platform || 'PS5'}</span></p>
                      <p><strong>プレイヤーID:</strong> <span id="profile-player-id">${profileData.playerId || '未設定'}</span></p>
                      <p><strong>メイン武器:</strong> <span id="profile-main-weapon">${profileData.mainWeapon || '未設定'}</span></p>
                      <p><strong>プレイ時間:</strong> <span id="profile-play-time">${profileData.playTime || 0}</span>時間</p>
                  </div>
                  <div class="profile-bio">
                      <h3>自己紹介</h3>
                      <p id="profile-bio">${profileData.bio || '自己紹介はまだありません。'}</p>
                  </div>
                  <button id="edit-profile-btn" class="btn btn-primary">プロフィールを編集</button>
              </div>
          </div>
          <div class="profile-stats">
              <h3>ハンター統計</h3>
              <div class="stats-cards">
                  <div class="stats-card">
                      <div class="stats-title">総ハント数</div>
                      <div id="profile-total-hunts" class="stats-value">0</div>
                  </div>
                  <div class="stats-card">
                      <div class="stats-title">平均クリアタイム</div>
                      <div id="profile-avg-time" class="stats-value">00:00.00</div>
                  </div>
                  <div class="stats-card">
                      <div class="stats-title">最も狩猟したモンスター</div>
                      <div id="profile-most-hunted" class="stats-value">-</div>
                  </div>
                  <div class="stats-card">
                      <div class="stats-title">最も使用した武器</div>
                      <div id="profile-most-used-weapon" class="stats-value">-</div>
                  </div>
                  <div class="stats-card">
                      <div class="stats-title">最速クリアタイム</div>
                      <div id="profile-best-time" class="stats-value">-</div>
                  </div>
                  <div class="stats-card">
                      <div class="stats-title">最速クリアモンスター</div>
                      <div id="profile-best-monster" class="stats-value">-</div>
                  </div>
              </div>
          </div>
      `;

          // --- 装備プリセットタブ本体 ---------------------------
          const presetTab = document.createElement('div');
          presetTab.id = 'equipment-tab';
          presetTab.className = 'tab-content';
          presetTab.innerHTML = `
              <div class="preset-header">
                  <h2>装備プリセット</h2>
                  <button id="add-preset-btn" class="btn btn-primary">
                      <i class="fas fa-plus"></i> 新規プリセット
                  </button>
              </div>
              <div id="presets-container" class="presets-container">
                  <!-- プリセットリストはJavaScriptで動的に生成 -->
              </div>
          `;

          // --- ボタンを追加 -------------------------------------
          const btnBar = nb.querySelector('.tab-buttons');

          const makeBtn = (text, tabId) => {
            const b = document.createElement('button');
            b.className = 'tab-button';
            b.textContent = text;
            b.onclick = () => openTab(tabId);
            btnBar.appendChild(b);
          };

          makeBtn('プロフィール',      'profile-tab');
          makeBtn('装備プリセット',   'equipment-tab');

          // --- コンテンツを挿入 ---------------------------------
          nb.appendChild(profileTab);
          nb.appendChild(presetTab);

          // 必要な初期化（元コードと同等）
          document.getElementById('edit-profile-btn')
                  .addEventListener('click', showProfileModal);
          document.getElementById('add-preset-btn')
                  .addEventListener('click', showPresetManagementModal);

          updatePresetList('presets-container');
          updateProfileStats();
          }
          // プロフィール統計を更新
          function updateProfileStats() {
              if (recordsData.length === 0) {
                  document.getElementById('profile-total-hunts').textContent = '0';
                  document.getElementById('profile-avg-time').textContent = '00:00.00';
                  document.getElementById('profile-most-hunted').textContent = '-';
                  document.getElementById('profile-most-used-weapon').textContent = '-';
                  document.getElementById('profile-best-time').textContent = '-';
                  document.getElementById('profile-best-monster').textContent = '-';
                  return;
              }

              // 統計データの計算
              // モンスター別カウント
              const monsterCounts = {};
              recordsData.forEach(record => {
                  monsterCounts[record.monster] = (monsterCounts[record.monster] || 0) + 1;
              });

              // 武器種別カウント
              const weaponCounts = {};
              recordsData.forEach(record => {
                  weaponCounts[record.weapon] = (weaponCounts[record.weapon] || 0) + 1;
              });

              // 平均クリアタイム計算
              let totalTime = 0;
              recordsData.forEach(record => {
                  totalTime += record.timeValue;
              });
              const avgTime = totalTime / recordsData.length;

              // 平均時間をフォーマット
              const avgMinutes = Math.floor(avgTime / (60 * 1000));
              const avgSeconds = Math.floor((avgTime % (60 * 1000)) / 1000);
              const avgMilliseconds = Math.floor((avgTime % 1000) / 10);
              const avgTimeString = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}.${avgMilliseconds.toString().padStart(2, '0')}`;

              // 最も狩猟したモンスターを見つける
              let mostHuntedMonster = '';
              let mostHuntedCount = 0;
              for (const [monster, count] of Object.entries(monsterCounts)) {
                  if (count > mostHuntedCount) {
                      mostHuntedMonster = monster;
                      mostHuntedCount = count;
                  }
              }

              // 最も使用した武器を見つける
              let mostUsedWeapon = '';
              let mostUsedCount = 0;
              for (const [weapon, count] of Object.entries(weaponCounts)) {
                  if (count > mostUsedCount) {
                      mostUsedWeapon = weapon;
                      mostUsedCount = count;
                  }
              }

              // 最速クリアタイムとモンスターを見つける
              let bestTime = Infinity;
              let bestTimeString = '';
              let bestMonster = '';

              recordsData.forEach(record => {
                  if (record.timeValue < bestTime) {
                      bestTime = record.timeValue;
                      bestTimeString = record.timeString;
                      bestMonster = record.monster;
                  }
              });

              // 統計表示を更新
              document.getElementById('profile-total-hunts').textContent = recordsData.length;
              document.getElementById('profile-avg-time').textContent = avgTimeString;
              document.getElementById('profile-most-hunted').textContent = `${mostHuntedMonster} (${mostHuntedCount}回)`;
              document.getElementById('profile-most-used-weapon').textContent = `${mostUsedWeapon} (${mostUsedCount}回)`;
              document.getElementById('profile-best-time').textContent = bestTimeString;
              document.getElementById('profile-best-monster').textContent = bestMonster;
          }

          // ヘッダーにプロフィール情報を追加
          function addProfileToHeader() {
              const header = document.querySelector('header');
              if (!header) return;

              // プロフィール要素を作成
              const profileElement = document.createElement('div');
              profileElement.className = 'header-profile';
              profileElement.id = 'header-profile';
              profileElement.innerHTML = `
                  <div class="header-profile-avatar">
                  </div>
                  <span class="header-profile-name">${profileData.hunterName || 'ハンター名未設定'}</span>
              `;

              // プロフィール表示・非表示の設定
              if (profileData.hunterName) {
                  profileElement.style.display = 'flex';
              } else {
                  profileElement.style.display = 'none';
              }

              // クリックでプロフィールモーダルを表示
              profileElement.addEventListener('click', showProfileModal);

              // ヘッダーの最後の子要素の前に挿入
              header.appendChild(profileElement);
          }

          // 記録と装備の連携初期化
          function initRecordEquipmentIntegration() {
              // 記録フォームを装備プリセット対応に拡張
              enhanceRecordForm();

              // 共有リンク処理を拡張
              const originalProcessShareLink = window.processShareLink;
              window.processShareLink = function() {
                  const urlParams = new URLSearchParams(window.location.search);
                  const shareParam = urlParams.get('share');

                  if (shareParam) {
                      try {
                          // Base64デコード
                          const shareData = JSON.parse(b64_to_utf8(shareParam));

                          if (shareData.type === 'record') {
                              processRecordShareLink(shareData);
                          } else if (shareData.type === 'preset') {
                              processPresetShareLink(shareData);
                          }
                      } catch (e) {
                          console.error('共有データの解析に失敗しました:', e);
                      }
                  }
              };

              // 記録保存処理を拡張
              const originalSaveRecord = window.saveRecord;
              window.saveRecord = async function(e) {
                  e.preventDefault();

                  // 基本情報を取得
                  const monster = document.getElementById('monster-select').value;
                  const weapon = document.getElementById('weapon-select').value;
                  const questType = document.getElementById('quest-type').value;
                  const stage = document.getElementById('stage-select').value;
                  const strength = document.getElementById('strength').value;
                  const minutes = parseInt(document.getElementById('time-minutes').value) || 0;
                  const seconds = parseInt(document.getElementById('time-seconds').value) || 0;
                  const milliseconds = parseInt(document.getElementById('time-milliseconds').value) || 0;
                  const notes = document.getElementById('notes').value;
                  const presetId = document.getElementById('preset-select') ? document.getElementById('preset-select').value : '';

                  // バリデーション
                  if (!monster || !weapon || !stage) {
                      alert('モンスター、武器種、ステージを選択してください');
                      return;
                  }

                  // 時間を文字列に変換
                  const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(2, '0')}`;

                  // 時間を比較用に数値に変換（ミリ秒単位）
                  const timeValue = (minutes * 60 * 1000) + (seconds * 1000) + milliseconds;

                  // 新しい記録オブジェクト
                  const newRecord = {
                    id: Date.now().toString(), // ユニークなID
                  monster,
                  weapon,
                  questType,
                  stage,
                  strength,
                  timeString,
                  timeValue,
                  notes,
                  hasImage: !!imageFile,
                  tags: document.getElementById('tags').value.split(',').map(tag => tag.trim()).filter(tag => tag !== ''),
                  date: new Date().toISOString(),
                  equipmentPresetId: presetId // 装備プリセットIDを追加
              };

              // 画像がある場合は保存
              if (imageFile) {
                  try {
                      // FileReaderを使って画像をBase64エンコード
                      const reader = new FileReader();
                      const imageDataPromise = new Promise((resolve) => {
                          reader.onload = (e) => resolve(e.target.result);
                          reader.readAsDataURL(imageFile);
                      });

                      const imageData = await imageDataPromise;
                      await saveImage(newRecord.id, imageData);
                  } catch (error) {
                      console.error('画像の保存に失敗しました:', error);
                      // エラーメッセージをUIに表示
                      const errorMsg = document.createElement('div');
                      errorMsg.className = 'error-message';
                      errorMsg.textContent = '画像の保存に失敗しました。もう一度お試しください。';
                      document.getElementById('imagePreviewContainer').appendChild(errorMsg);
                      setTimeout(() => errorMsg.remove(), 3000);
                      return;
                  }
              }

              // 記録を追加
              recordsData.push(newRecord);

              // データをソート（時間の早い順）
              recordsData.sort((a, b) => a.timeValue - b.timeValue);

              // データを保存
              saveRecordsToStorage();

              // フィルターセレクト更新
              updateFilterSelects();

              // テーブルを更新
              renderRecordsTable();

              // フォームをリセット
              document.getElementById('record-form').reset();

              // 画像プレビューをリセット
              imageFile = null;
              document.getElementById('imageUploadContainer').style.display = 'block';
              document.getElementById('imagePreviewContainer').style.display = 'none';
              document.getElementById('formPreviewImage').src = '';
              document.getElementById('imageUpload').value = '';

              // 統計情報を更新
              updateStatistics();

              // チェックリストを更新
              updateChecklist();

              // ランキングを更新
              updateRankings();

              // トレンドを更新（表示中の場合）
              if (document.getElementById('trends').classList.contains('active')) {
                  updateTrendChart();
              }

              // プロフィール統計を更新
              updateProfileStats();

              alert('記録が保存されました！');
          };
        }

        // DOMContentLoadedイベントを拡張
        document.addEventListener('DOMContentLoaded', async function() {
          // オリジナルの初期化コードは維持

          // プロファイルとプリセットを読み込み
          loadProfile();
          loadPresets();

          // 装備データ（JSONファイル）も読み込み
          await loadEquipmentData();

          // タブノートブックを取得
          let notebook = null;
          for (const element of document.querySelectorAll('.TNotebook, .tab-container')) {
              if (element.classList.contains('TNotebook') ||
                  (element.classList.contains('tab-container') && element.querySelector('.tab-buttons'))) {
                  notebook = element;
                  break;
              }
          }

          if (notebook) {
              // プロフィールと装備プリセットタブを追加
              addProfileEquipmentTabs(notebook);
          }

          // ヘッダーにプロフィール表示を追加
          addProfileToHeader();

          // 記録と装備の連携初期化
          initRecordEquipmentIntegration();
        });

        // スタイルを追加
        const profileStyle = document.createElement('style');
        profileStyle.textContent = `
          /* プロフィール関連スタイル */
          .header-profile {
              position: absolute;
              right: 60px;
              top: 20px;
              display: flex;
              align-items: center;
              background: rgba(255, 255, 255, 0.2);
              padding: 5px 10px;
              border-radius: 20px;
              cursor: pointer;
              transition: var(--transition);
          }

          .header-profile:hover {
              background: rgba(255, 255, 255, 0.3);
          }

          .header-profile-avatar {
              width: 30px;
              height: 30px;
              border-radius: 50%;
              overflow: hidden;
              margin-right: 8px;
          }

          .header-profile-avatar img {
              width: 100%;
              height: 100%;
              object-fit: cover;
          }

          .header-profile-name {
              color: white;
              font-weight: 500;
          }

          /* プロフィールページスタイル */
          .profile-header {
              display: flex;
              padding: 20px;
              background: var(--card-bg);
              border-radius: var(--border-radius);
              box-shadow: var(--shadow);
              margin-bottom: 20px;
          }

          .profile-avatar-large {
              width: 150px;
              height: 150px;
              border-radius: 50%;
              overflow: hidden;
              margin-right: 30px;
              flex-shrink: 0;
              border: 4px solid var(--accent);
          }

          .profile-avatar-large img {
              width: 100%;
              height: 100%;
              object-fit: cover;
          }

          .profile-info {
              flex: 1;
          }

          .profile-info h2 {
              margin-top: 0;
              margin-bottom: 15px;
              color: var(--primary);
          }

          .profile-details {
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
              gap: 10px;
              margin-bottom: 20px;
          }

          .profile-details p {
              margin: 5px 0;
          }

          .profile-bio {
              margin-bottom: 20px;
          }

          .profile-bio h3 {
              margin-bottom: 10px;
              font-size: 1.1rem;
              color: var(--primary);
          }

          .profile-stats {
              padding: 20px;
              background: var(--card-bg);
              border-radius: var(--border-radius);
              box-shadow: var(--shadow);
          }

          .profile-stats h3 {
              margin-top: 0;
              margin-bottom: 15px;
              color: var(--primary);
          }

          .stats-cards {
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
              gap: 15px;
          }

          /* プロフィール編集モーダル */
          .profile-modal {
              max-width: 600px;
          }

          .profile-avatar-container {
              display: flex;
              justify-content: center;
              margin-bottom: 20px;
          }

          .profile-avatar-wrapper {
              position: relative;
              width: 120px;
              height: 120px;
              border-radius: 50%;
              overflow: hidden;
              cursor: pointer;
          }

          .profile-avatar-wrapper img {
              width: 100%;
              height: 100%;
              object-fit: cover;
          }

          .avatar-overlay {
              position: absolute;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0, 0, 0, 0.5);
              color: white;
              display: flex;
              flex-direction: column;
              justify-content: center;
              align-items: center;
              opacity: 0;
              transition: opacity 0.3s;
          }

          .profile-avatar-wrapper:hover .avatar-overlay {
              opacity: 1;
          }

          .form-row {
              display: flex;
              gap: 15px;
          }

          .form-group.half {
              flex: 1;
          }

          /* 装備プリセット関連スタイル */
          .preset-header {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
          }

          .presets-container {
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
              gap: 20px;
          }

          .preset-card {
              background: var(--card-bg);
              border-radius: var(--border-radius);
              box-shadow: var(--shadow);
              transition: var(--transition);
              overflow: hidden;
          }

          .preset-card:hover {
              transform: translateY(-3px);
              box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
          }

          .preset-card .card-header {
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 12px 15px;
              background: var(--primary);
              color: white;
          }

          .preset-actions {
              display: flex;
              gap: 5px;
          }

          .preset-equipment {
              margin-bottom: 15px;
          }

          .preset-equipment > div {
              margin-bottom: 5px;
          }

          .preset-skills {
              margin-bottom: 15px;
          }

          .skills-container {
              display: flex;
              flex-wrap: wrap;
              gap: 5px;
              margin-top: 5px;
          }

          .preset-footer {
              display: flex;
              justify-content: space-between;
              margin-top: 15px;
          }

          /* プリセット管理モーダル */
          .preset-management-modal {
              max-width: 800px;
              max-height: 80vh;
          }

          .preset-tabs {
              display: flex;
              border-bottom: 2px solid var(--background-dark);
              margin-bottom: 20px;
          }

          .preset-tab {
              padding: 10px 20px;
              background: none;
              border: none;
              font-weight: 600;
              color: var(--text-light);
              cursor: pointer;
              transition: var(--transition);
              position: relative;
          }

          .preset-tab:hover {
              color: var(--primary);
          }

          .preset-tab.active {
              color: var(--primary);
          }

          .preset-tab.active::after {
              content: '';
              position: absolute;
              bottom: -2px;
              left: 0;
              width: 100%;
              height: 2px;
              background-color: var(--primary);
          }

          .preset-tab-content {
              display: none;
              max-height: 60vh;
              overflow-y: auto;
          }

          .preset-tab-content.active {
              display: block;
              animation: fadeIn 0.3s ease;
          }

          /* フォーム拡張スタイル */
          .preset-select-container {
              display: flex;
              gap: 5px;
          }

          .preset-btn {
              padding: 0.75rem;
              flex-shrink: 0;
          }

          /* 共有コンテンツのスタイル */
          .shared-equipment {
              margin-top: 20px;
              padding: 15px;
              border: 1px solid var(--accent);
              border-radius: var(--border-radius);
              background-color: rgba(231, 199, 142, 0.1);
          }

          .shared-equipment h4 {
              margin-top: 0;
              margin-bottom: 10px;
              color: var(--primary);
          }

          .equipment-details, .equipment-skills {
              margin-bottom: 15px;
          }

          .equipment-notes {
              padding-top: 10px;
              border-top: 1px solid rgba(0, 0, 0, 0.1);
          }

          /* トースト通知 */
          .toast-message {
              position: fixed;
              bottom: 20px;
              right: 20px;
              background: var(--primary);
              color: white;
              padding: 10px 20px;
              border-radius: 4px;
              box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
              z-index: 9999;
              transform: translateY(100px);
              opacity: 0;
              transition: transform 0.3s, opacity 0.3s;
          }

          .toast-message.toast-show {
              transform: translateY(0);
              opacity: 1;
          }

          /* モーダルメッセージ */
          .modal-message {
              padding: 10px 15px;
              margin: 10px 0;
              border-radius: 4px;
              transform: translateY(20px);
              opacity: 0;
              transition: transform 0.3s, opacity 0.3s;
          }

          .modal-message.success {
              background-color: #d4edda;
              color: #155724;
          }

          .modal-message.error {
              background-color: #f8d7da;
              color: #721c24;
          }

          .modal-message.show {
              transform: translateY(0);
              opacity: 1;
          }

          /* レスポンシブ対応 */
          @media (max-width: 768px) {
              .profile-header {
                  flex-direction: column;
              }

              .profile-avatar-large {
                  margin: 0 auto 20px;
              }

              .profile-details {
                  grid-template-columns: 1fr;
              }

              .stats-cards {
                  grid-template-columns: 1fr;
              }

              .presets-container {
                  grid-template-columns: 1fr;
              }

              .form-row {
                  flex-direction: column;
                  gap: 5px;
              }

              .preset-select-container {
                  flex-direction: column;
              }

              .header-profile {
                  right: 10px;
                  top: 10px;
              }

              .header-profile-name {
                  display: none;
              }
          }
        `;

        document.head.appendChild(profileStyle);
    </script>
  </body>
</html>
